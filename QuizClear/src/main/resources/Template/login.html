<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>QuizClear - Login</title>
        <link rel="stylesheet" href="../static/login.css">
        <link rel="stylesheet" th:href="@{/static/login.css}">
    </head>
    <body>
        <div class="container">
            <div class="login-box">
                <div class="login-info">
                    <div class="logo-title">
                        <span class="logo">
                            <svg width="40" height="37" viewBox="0 0 50 46" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M45.9521 8.89538L30.5896 1.57663C27.2079 -0.443293 22.9989 -0.479133 19.5833 1.48288L4.04797 8.89538C3.98966 8.92458 3.92921 8.95583 3.87296 8.98913C0.186246 11.0971 -1.09364 15.7947 1.01437 19.4814C1.72892 20.7312 2.78 21.7552 4.04797 22.4371L8.33341 24.4788V34.6871C8.33595 39.2518 11.3062 43.2846 15.6647 44.6413C18.6978 45.5187 21.8428 45.9483 25.0001 45.9163C28.1569 45.9516 31.302 45.5257 34.3356 44.6517C38.6941 43.2952 41.6643 39.2623 41.6668 34.6975V24.4746L45.8335 22.4829V39.6662C45.8335 40.8168 46.7662 41.7495 47.9168 41.7495C49.0674 41.7495 50.0001 40.8168 50.0001 39.6662V14.6662C50.014 12.2198 48.0823 9.95983 45.9521 8.89538ZM37.5 34.6975C37.5011 37.4279 35.7296 39.843 33.125 40.6621C30.4838 41.4168 27.7468 41.7831 25 41.7496C22.2532 41.7831 19.5162 41.4168 16.875 40.6621C14.2704 39.8429 12.4989 37.4279 12.5 34.6975V26.4642L19.4105 29.7559C21.1155 30.7684 23.0629 31.3005 25.0459 31.2955C26.9334 31.3089 28.7892 30.8091 30.4147 29.8497L37.5 26.4641V34.6975ZM44.1667 18.6766L28.4542 26.1766C26.2634 27.4523 23.5479 27.4162 21.3917 26.0829L6.01877 18.7704C4.30519 17.8464 3.66515 15.7082 4.58918 13.9947C4.90168 13.4152 5.37023 12.9348 5.94171 12.6079L21.5563 5.14958C23.7478 3.87673 26.4618 3.91276 28.6188 5.24333L43.9813 12.5621C45.1111 13.1894 45.8179 14.3741 45.8333 15.6663C45.8354 16.8903 45.2051 18.0286 44.1667 18.6766Z" fill="#0088F0" />
                            </svg>
                        </span>
                        <span class="title">QuizClear</span>
                    </div>
                    <div class="subtitle">No Duplicates. Clear Quizzes. QuizClear.</div>
                    <h1 class="login-header">Login</h1>
                </div>

                <form class="login-form" id="loginForm">
                    <div class="input-group">
                        <input type="email" id="email" name="email" placeholder="Enter email" class="input-field" required>
                    </div>
                    <div class="input-group">
                        <input type="password" id="password" name="password" placeholder="Enter password" class="input-field password-input" required>
                        <span class="toggle-password" tabindex="0">
                            <svg class="eye-icon eye-off" width="22" height="22" viewBox="0 0 24 24" fill="none">
                                <path d="M1 12C1 12 5 5 12 5C19 5 23 12 23 12C23 12 19 19 12 19C5 19 1 12 1 12Z" stroke="#222" stroke-width="2" />
                                <path d="M4 4L20 20" stroke="#222" stroke-width="2" stroke-linecap="round" />
                                <circle cx="12" cy="12" r="3" stroke="#222" stroke-width="2" />
                            </svg>
                            <svg class="eye-icon eye-on" width="22" height="22" viewBox="0 0 24 24" fill="none">
                                <path d="M1 12C1 12 5 5 12 5C19 5 23 12 23 12C23 12 19 19 12 19C5 19 1 12 1 12Z" stroke="#222" stroke-width="2" />
                                <circle cx="12" cy="12" r="3" stroke="#222" stroke-width="2" />
                            </svg>
                        </span>
                    </div>
                    <button type="submit" class="login-btn" id="loginBtn">Login</button>
                    <div id="errorMessage" class="error-message" style="display: none;"></div>
                    <div class="forgot">
                        Forgot your <a href="#" class="password-link">password</a> ?
                    </div>
                </form>
            </div>

            <div class="footer">
                <div class="language">
                    Language
                    <span class="dropdown">
                        English
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none">
                            <path d="M7 10l5 5 5-5" stroke="#888" stroke-width="2" fill="none" />
                        </svg>
                    </span>
                </div>
                <div class="support">Support</div>
            </div>
        </div>

        <div id="forgot-modal-overlay" class="modal-overlay"></div>
        <div id="forgot-modal" class="modal">
            <div class="modal-header">
                <button id="modal-back" class="modal-back"><</button>
                <span class="modal-title">Forgot Password?</span>
                <button id="modal-close" class="modal-close">×</button>
            </div>
            <div class="modal-body">
                <p class="modal-desc">Please fill in your account information.</p>
                <form class="forgot-form" id="forgotPasswordForm">
                    <div class="modal-input-group">
                        <input type="email" id="forgotEmail" name="forgotEmail" class="modal-input" placeholder="Enter your email" required>
                        <button type="button" class="send-code-btn" id="sendCodeBtn">Get Code</button>
                    </div>
                    <div class="modal-input-group" id="codeGroup" style="display: none;">
                        <input type="text" id="verificationCode" name="verificationCode" class="modal-input" placeholder="Enter verification code">
                    </div>
                    <div class="modal-input-group" id="newPasswordGroup" style="display: none;">
                        <input type="password" id="newPassword" name="newPassword" class="modal-input" placeholder="Enter new password">
                    </div>
                    <button type="submit" class="modal-submit-btn" id="forgotSubmitBtn" style="display: none;">Reset Password</button>
                    <div id="forgotErrorMessage" class="error-message" style="display: none;"></div>
                </form>
                <div class="modal-note">If you do not receive the code, please contact us for assistance.</div>
            </div>
        </div>

        <script>
            // Toggle password visibility
            const togglePassword = document.querySelector('.toggle-password');
            const passwordInput = document.querySelector('.password-input');
            const eyeOff = document.querySelector('.eye-off');
            const eyeOn = document.querySelector('.eye-on');

            togglePassword.addEventListener('click', function() {
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                eyeOff.style.display = type === 'password' ? 'block' : 'none';
                eyeOn.style.display = type === 'password' ? 'none' : 'block';
            });

            // Login form submission
            document.getElementById('loginForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const loginBtn = document.getElementById('loginBtn');
                const errorMessage = document.getElementById('errorMessage');
                console.log('Login attempt:', { email, password });
                loginBtn.textContent = 'Logging in...';
                loginBtn.disabled = true;
                errorMessage.style.display = 'none';

                try {
                    const response = await fetch('api/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });
                    const data = await response.json();
                    if (data.success) {
                        localStorage.setItem('user', JSON.stringify(data.user));
                        localStorage.setItem('isLoggedIn', 'true');
                        loginBtn.textContent = 'Success! Redirecting...';
                        loginBtn.style.backgroundColor = '#28a745';
                        setTimeout(() => {
                            let dashboardMap = {
                                "/staff-dashboard": "/Template/Staff/staffDashboard.html",
                                "/lecturer-dashboard": "/Template/Lecturer/lecturerDashboard.html",
                                "/sl-dashboard": "/Template/subjectLeader/slDashboard.html",
                                "/hed-dashboard": "/Template/HEAD_OF_DEPARTMENT/HED_Dashboard.html",
                                "/hoe-dashboard": "/Template/Head of Examination Department/HOE_Dashboard.html"
                            };
                            let dashboardUrl = dashboardMap[data.redirectUrl] || "/login.html";
                            window.location.href = dashboardUrl;
                        }, 1000);
                    } else {
                        errorMessage.textContent = data.message;
                        errorMessage.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    errorMessage.textContent = 'Network error. Please check your connection and try again.';
                    errorMessage.style.display = 'block';
                } finally {
                    if (loginBtn.textContent !== 'Success! Redirecting...') {
                        loginBtn.textContent = 'Login';
                        loginBtn.disabled = false;
                        loginBtn.style.backgroundColor = '';
                    }
                }
            });

            // Modal functionality
            const forgotLink = document.querySelector('.password-link');
            const modal = document.getElementById('forgot-modal');
            const overlay = document.getElementById('forgot-modal-overlay');
            const closeBtn = document.getElementById('modal-close');
            const backBtn = document.getElementById('modal-back');

            function openModal() {
                modal.style.display = 'block';
                overlay.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }

            function closeModal() {
                modal.style.display = 'none';
                overlay.style.display = 'none';
                document.body.style.overflow = '';
                // Reset form trạng thái
                document.getElementById('forgotPasswordForm').reset();
                document.getElementById('codeGroup').style.display = 'none';
                document.getElementById('newPasswordGroup').style.display = 'none';
                document.getElementById('forgotSubmitBtn').style.display = 'none';
                document.getElementById('sendCodeBtn').style.display = 'inline-block';
                document.getElementById('forgotErrorMessage').style.display = 'none';
                document.getElementById('verificationCode').required = false;
                document.getElementById('newPassword').required = false;
            }

            forgotLink.addEventListener('click', function(e) {
                e.preventDefault();
                openModal();
            });

            closeBtn.addEventListener('click', closeModal);
            backBtn.addEventListener('click', closeModal);
            overlay.addEventListener('click', closeModal);

            // Forgot password - Request code
            document.getElementById('sendCodeBtn').addEventListener('click', async function() {
                const email = document.getElementById('forgotEmail').value;
                const sendCodeBtn = document.getElementById('sendCodeBtn');
                const errorMessage = document.getElementById('forgotErrorMessage');
                const codeGroup = document.getElementById('codeGroup');

                errorMessage.style.display = 'none';
                sendCodeBtn.textContent = 'Gửi...';
                sendCodeBtn.disabled = true;

                try {
                    const response = await fetch('/api/auth/request-reset-code', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email })
                    });

                    const data = await response.json();

                    if (data.success) {
                        alert(`Mã xác nhận của bạn: ${data.code}`);
                        codeGroup.style.display = 'block';
                        sendCodeBtn.style.display = 'none';
                        document.getElementById('forgotSubmitBtn').style.display = 'block';
                        document.getElementById('verificationCode').required = true;
                    } else {
                        errorMessage.textContent = data.message;
                        errorMessage.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Lỗi yêu cầu mã:', error);
                    errorMessage.textContent = 'Lỗi mạng. Vui lòng thử lại.';
                    errorMessage.style.display = 'block';
                } finally {
                    sendCodeBtn.textContent = 'Lấy mã';
                    sendCodeBtn.disabled = false;
                }
            });

            // Forgot password - Submit form
            document.getElementById('forgotPasswordForm').addEventListener('submit', async function(e) {
                e.preventDefault();

                const email = document.getElementById('forgotEmail').value;
                const verificationCode = document.getElementById('verificationCode').value;
                const newPassword = document.getElementById('newPassword').value;
                const submitBtn = document.getElementById('forgotSubmitBtn');
                const errorMessage = document.getElementById('forgotErrorMessage');
                const newPasswordGroup = document.getElementById('newPasswordGroup');

                errorMessage.style.display = 'none';
                submitBtn.textContent = 'Đang xử lý...';
                submitBtn.disabled = true;

                try {
                    // Bước 1: Xác minh mã xác nhận
                    const verifyResponse = await fetch('/api/auth/verify-reset-code', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, code: verificationCode })
                    });

                    const verifyData = await verifyResponse.json();

                    if (!verifyData.success) {
                        errorMessage.textContent = verifyData.message;
                        errorMessage.style.display = 'block';
                        submitBtn.textContent = 'Đặt lại mật khẩu';
                        submitBtn.disabled = false;
                        return;
                    }

                    // Bước 2: Nếu mã đúng, hiển thị ô nhập mật khẩu mới
                    if (!newPasswordGroup.style.display || newPasswordGroup.style.display === 'none') {
                        newPasswordGroup.style.display = 'block';
                        submitBtn.textContent = 'Xác nhận đặt lại';
                        submitBtn.disabled = false;
                        document.getElementById('newPassword').required = true;
                        return;
                    }

                    // Bước 3: Gửi yêu cầu đặt lại mật khẩu
                    const resetResponse = await fetch('/api/auth/reset-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, newPassword })
                    });

                    const resetData = await resetResponse.json();

                    if (resetData.success) {
                        submitBtn.textContent = 'Thành công! Đang chuyển hướng...';
                        submitBtn.style.backgroundColor = '#28a745';
                        setTimeout(() => {
                            closeModal();
                            window.location.reload();
                        }, 1000);
                    } else {
                        errorMessage.textContent = resetData.message;
                        errorMessage.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Lỗi đặt lại mật khẩu:', error);
                    errorMessage.textContent = 'Lỗi mạng. Vui lòng thử lại.';
                    errorMessage.style.display = 'block';
                } finally {
                    if (submitBtn.textContent !== 'Thành công! Đang chuyển hướng...') {
                        submitBtn.textContent = newPasswordGroup.style.display === 'block' ? 'Xác nhận đặt lại' : 'Đặt lại mật khẩu';
                        submitBtn.disabled = false;
                    }
                }
            });

            // Quick fill functionality
            document.querySelectorAll('.test-accounts div').forEach(div => {
                if (div.innerHTML.includes('@')) {
                    div.style.cursor = 'pointer';
                    div.title = 'Nhấp đúp để tự động điền';
                    div.addEventListener('dblclick', function() {
                        const text = this.textContent;
                        const emailMatch = text.match(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/);
                        const passwordMatch = text.match(/(hash_[a-zA-Z0-9]+)/);
                        
                        if (emailMatch && passwordMatch) {
                            document.getElementById('email').value = emailMatch[1];
                            document.getElementById('password').value = passwordMatch[1];
                            this.style.backgroundColor = '#d4edda';
                            setTimeout(() => {
                                this.style.backgroundColor = '';
                            }, 1000);
                        }
                    });
                }
            });
        </script>
    </body>
</html>