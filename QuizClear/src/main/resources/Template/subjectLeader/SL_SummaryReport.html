<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- FontAwesome - try local first, fallback to CDN -->
    <link rel="stylesheet" th:href="@{/Static/fontawesome/css/all.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
        onerror="this.onerror=null;this.href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css';">
    <!-- Other CSS files -->
    <link rel="stylesheet" th:href="@{/Static/header.css}">
    <link rel="stylesheet" th:href="@{/Static/Menu-Staff.css}">
    <link rel="stylesheet" th:href="@{/Static/web_styles.css}">
    <link rel="stylesheet" th:href="@{/Static/css/subjectLeader/SL_SummaryReport.css}">

    <link href="https://fonts.googleapis.com/css2?family=RocknRoll+One&display=swap" rel="stylesheet">
    <title>SummaryReport</title>
</head>

<body>
    <!--header-->
    <div th:replace="~{header_user :: header}"></div>

    <!-- body -->
    <div id="Container-body">
        <!-- Menu -->
        <div th:insert="~{subjectLeader/Menu-SL :: Menu-SL}"></div>

        <!-- Main content -->
        <div id="main">
            <!-- Summary Report Main Page -->
            <div id="summaryReportPage" class="page-content">
                <div class="page-header">
                    <h1>Summary Report</h1>
                    <p class="page-subtitle">Overview of approved questions ready to submit to department heads or R&D
                    </p>
                </div>

                <div class="search-filter-section">
                    <div class="search-filter-bar">
                        <div class="search-box">
                            <input type="text" placeholder="Enter search content ..." class="search-input">
                            <button class="search-btn">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>

                        <div class="filter-dropdown">
                            <select class="filter-select">
                                <option>All Summary</option>
                                <option>Completed</option>
                                <option>Draft</option>
                                <option>Pending</option>
                            </select>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    </div>

                    <button class="new-summary-btn" onclick="openNewSummaryModal()">
                        <span class="plus-icon">+</span>
                        New Summary
                    </button>
                </div>


                <div class="summary-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Summary ID</th>
                                <th>Recipient</th>
                                <th>No. of Ques</th>
                                <th>Created Date</th>
                                <th>FB Status</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="report : ${reports}">
                                <td th:text="'RP_S' + ${report.sumId}">ID</td>
                                <td th:text="${report.assignedTo.fullName}">Recipient</td>
                                <td th:text="${report.totalQuestions}">Ques</td>
                                <td th:text="${#temporals.format(report.createdAt, 'dd/MM/yy')}">Date</td>
                                <td>
                                    <span
                                        th:class="'fb-status ' + (${report.feedbackStatus.name().toLowerCase().replace('_', '-')})"
                                        th:text="${report.feedbackStatus.value}">FB Status</span>
                                </td>

                                <td>
                                    <span th:class="'status ' + ${report.status.name().toLowerCase()}"
                                        th:text="${report.status.value}">Status</span>
                                </td>

                                <td>
                                    <button class="action-btn view"
                                        th:onclick="'viewSummaryDetails(' + ${report.sumId} + ')'" title="View">
                                        <i class="fas fa-eye"></i>
                                    </button>

                                    <button class="action-btn edit" th:onclick="'editSummary(' + ${report.sumId} + ')'"
                                        title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Summary Details Page -->
            <div id="summaryDetailsPage" class="page-content" style="display: none;">
                <div class="page-header">
                    <button class="back-btn" onclick="goBackToMain()">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <h1>Details</h1>
                </div>

                <div class="information-section">
                    <h2>Information</h2>
                    <p class="section-subtitle">Display all related information</p>

                    <div class="info-grid">
                        <div class="info-row">
                            <div class="info-field">
                                <label>ID</label>
                                <input type="text" id="detailId" value="DB_S102" readonly>
                            </div>
                            <div class="info-field">
                                <label>Title</label>
                                <input type="text" id="detailTitle" value="Midterm Test" readonly>
                            </div>
                            <div class="info-field">
                                <label>Created by</label>
                                <input type="text" id="detailCreatedBy" value="Nguyen Van A" readonly>
                            </div>
                        </div>

                        <div class="info-row">
                            <div class="info-field">
                                <label>Number of Question</label>
                                <input type="text" id="detailQuestions" value="20" readonly>
                            </div>
                            <div class="info-field">
                                <label>Submission Date</label>
                                <input type="text" id="detailSubmissionDate" value="23/4/25" readonly>
                            </div>
                        </div>

                        <div class="info-row">
                            <div class="info-field">
                                <label>Recipient</label>
                                <input type="text" id="detailRecipient" value="Department Head" readonly>
                            </div>

                            <div class="info-field">
                                <label>Status</label>
                                <input type="text" id="detailStatus" value="Received" readonly>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="question-list-section">
                    <h2>Question list</h2>
                    <p class="section-subtitle">Display the list of questions and all related information</p>

                    <div class="questions-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Contributor</th>
                                    <th>Diff. Levels</th>
                                    <th>Updated Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Q101</td>
                                    <td>Nguyen Van A</td>
                                    <td>Reg</td>
                                    <td>22/04/25</td>
                                    <td><span class="status approved">Approved</span></td>
                                </tr>
                                <tr>
                                    <td>Q101</td>
                                    <td>Nguyen Van A</td>
                                    <td>Reg</td>
                                    <td>22/04/25</td>
                                    <td><span class="status approved">Approved</span></td>
                                </tr>
                                <tr>
                                    <td>Q101</td>
                                    <td>Nguyen Van A</td>
                                    <td>Reg</td>
                                    <td>22/04/25</td>
                                    <td><span class="status approved">Approved</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- New Summary Modal -->
    <div class="modal-overlay" id="modalOverlay"></div>
    <div class="modal" id="newSummaryModal">
        <div class="modal-header">
            <h2 id="modalTitle">New Summary</h2>
            <button class="modal-close" onclick="closeNewSummaryModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="modal-form">
                <div class="form-row">
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="summaryTitle" placeholder="Midterm Test" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Recipient</label>
                        <input type="text" id="summaryRecipient" placeholder="Department Head" class="form-input">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Total Ques.</label>
                        <input type="number" id="summaryTotalQues" placeholder="20" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Submission Date</label>
                        <input type="text" id="summarySubmissionDate" placeholder="23/05/25" class="form-input">
                    </div>
                </div>

                <div class="form-group full-width">
                    <label>Questions</label>
                    <div class="dropdown-container">
                        <select id="summaryQuestions" class="form-select">
                            <option value="">Multi Select</option>
                            <option value="q1">Question 1 - Database Basics</option>
                            <option value="q2">Question 2 - SQL Queries</option>
                            <option value="q3">Question 3 - Normalization</option>
                        </select>
                        <i class="fas fa-chevron-down dropdown-arrow"></i>
                    </div>
                </div>

                <div class="form-group full-width">
                    <label>Notes</label>
                    <textarea id="summaryNotes"
                        placeholder="Please prepare the exam questions based on the course content, covering different levels of difficulty and question types where appropriate."
                        class="form-textarea"></textarea>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel" onclick="closeNewSummaryModal()">Cancel</button>
            <button class="modal-btn save-draft" onclick="saveAsDraft()">Save as Draft</button>
            <button class="modal-btn create" id="submitBtn" onclick="createSummary()">Create</button>
        </div>
    </div>
    <!-- JavaScript -->
    <script>
        // Set active menu for current page
        document.addEventListener('DOMContentLoaded', function () {
            // Wait a bit to ensure menu is loaded from Thymeleaf
            setTimeout(() => {
                const menuItems = document.querySelectorAll('#Menu-Staff .elements');
                menuItems.forEach(item => {
                    const link = item.querySelector('a');
                    if (link && link.getAttribute('href') === '/subject-leader/summary-report') {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });
            }, 100);
        });

        function formatDate(dateString) {
        if (!dateString) return '';
        const isoString = dateString.replace(' ', 'T');
        const date = new Date(isoString);
        if (isNaN(date)) return '';
        return date.toLocaleDateString('en-GB'); // dd/mm/yyyy
    }

        function mapStatusValue(status) {
            switch (status) {
                case 'DRAFT': return 'Draft';
                case 'SUBMITTED': return 'Submitted';
                case 'APPROVED': return 'Approved';
                case 'REJECTED': return 'Rejected';
                case 'ARCHIVED': return 'Archived';
                case 'DECLINED': return 'Declined';
                default: return status;
            }
        }

        function formatDifficulty(level) {
            switch ((level || '').toLowerCase()) {
                case 'recognition': return 'Recognition';
                case 'comprehension': return 'Comprehension';
                case 'basic_application': return 'Apply (Basic)';
                case 'advanced_application': return 'Apply (Advanced)';
                default: return level;
            }
        }

        function mapSumStatus(statusKey) {
        switch (statusKey) {
            case 'COMPLETED': return 'Completed';
            case 'DRAFT': return 'Draft';
            case 'PENDING': return 'Pending';
            default: return statusKey; 
        }
    }

        function viewSummaryDetails(summaryId) {
            fetch(`/subject-leader/api/summary-report/${summaryId}`)

                .then(response => {
                    if (!response.ok) {
                        throw new Error('Không tìm thấy bản tóm tắt');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('[DEBUG] Summary report data:', data); // DEBUG
                    // Ẩn trang danh sách, hiện trang chi tiết
                    document.getElementById('summaryReportPage').style.display = 'none';
                    document.getElementById('summaryDetailsPage').style.display = 'block';

                    // Gán dữ liệu vào form
                    document.getElementById('detailId').value = 'RP_S' + data.sumId;
                    document.getElementById('detailTitle').value = data.title || '';
                    document.getElementById('detailRecipient').value = data.assignedTo?.department || '';
                    document.getElementById('detailQuestions').value = data.totalQuestions || '';
                    document.getElementById('detailSubmissionDate').value = formatDate(data.createdAt) || '';
                    document.getElementById('detailCreatedBy').value = data.assignedBy ? data.assignedBy.fullName : '';
                    document.getElementById('detailStatus').value = mapSumStatus(data.status) || '';



                    // Nếu có danh sách câu hỏi => thêm vào bảng
                    if (data.questions && Array.isArray(data.questions)) {
                        const tbody = document.querySelector('.questions-table tbody');
                        tbody.innerHTML = '';

                        data.questions.forEach(q => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                        <td>${q.id}</td>
                        <td>${q.contributor}</td>
                        <td>${formatDifficulty(q.difficulty)}</td>
                        <td>${q.createdAt ? formatDate(q.createdAt) : ''}</td>
                        <td>
                            <span class="status ${q.status ? q.status.toLowerCase() : 'unknown'}">
                                ${mapStatusValue(q.status)}
                            </span>
                        </td>


                    `;
                            tbody.appendChild(tr);
                        });
                    }
                })
                .catch(error => {
                    alert(error.message);
                });
        }

        function goBackToMain() {
            document.getElementById('summaryDetailsPage').style.display = 'none';
            document.getElementById('summaryReportPage').style.display = 'block';
        } function editSummary(summaryId) {
            // Open edit modal with existing data
            openEditSummaryModal(summaryId);
        }

        // Modal functions
        function openNewSummaryModal() {
            // Reset modal for new summary
            document.getElementById('modalTitle').textContent = 'New Summary';
            document.getElementById('submitBtn').textContent = 'Create';
            document.getElementById('submitBtn').onclick = createSummary;

            // Clear form
            clearForm();

            document.getElementById('modalOverlay').style.display = 'block';
            document.getElementById('newSummaryModal').style.display = 'block';
        }

        function openEditSummaryModal(summaryId) {
            // Set modal for edit
            document.getElementById('modalTitle').textContent = 'Edit Summary';
            document.getElementById('submitBtn').textContent = 'Update';
            document.getElementById('submitBtn').onclick = function () { updateSummary(summaryId); };

            // Populate form with existing data based on summaryId
            populateFormWithExistingData(summaryId);

            document.getElementById('modalOverlay').style.display = 'block';
            document.getElementById('newSummaryModal').style.display = 'block';
        }

        function populateFormWithExistingData(summaryId) {
            // This would normally fetch data from backend based on summaryId
            // For now, using sample data
            document.getElementById('summaryTitle').value = 'Midterm Test';
            document.getElementById('summaryRecipient').value = 'Department Head';
            document.getElementById('summaryTotalQues').value = '20';
            document.getElementById('summarySubmissionDate').value = '23/05/25';
            document.getElementById('summaryNotes').value = 'Sample notes for editing...';
        }

        function clearForm() {
            const form = document.querySelector('.modal-form');
            const inputs = form.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                if (input.type === 'text' || input.type === 'number' || input.tagName === 'TEXTAREA') {
                    input.value = '';
                } else if (input.tagName === 'SELECT') {
                    input.selectedIndex = 0;
                }
            });

        }
        function closeNewSummaryModal() {
            document.getElementById('modalOverlay').style.display = 'none';
            document.getElementById('newSummaryModal').style.display = 'none';
            // Clear form when closing
            clearForm();
        }

        function saveAsDraft() {
            // Save as draft logic
            alert('Summary saved as draft!');
            closeNewSummaryModal();
        }

        function createSummary() {
            // Create summary logic
            const title = document.getElementById('summaryTitle').value;
            const recipient = document.getElementById('summaryRecipient').value;

            if (title && recipient) {
                alert('Summary created successfully!');
                closeNewSummaryModal();
                // Refresh table or add new row
            } else {
                alert('Please fill in all required fields');
            }
        }

        function updateSummary(summaryId) {
            // Update summary logic
            const title = document.getElementById('summaryTitle').value;
            const recipient = document.getElementById('summaryRecipient').value;

            if (title && recipient) {
                alert('Summary updated successfully! ID: ' + summaryId);
                closeNewSummaryModal();
                // Refresh table or update existing row
            } else {
                alert('Please fill in all required fields');
            }
        }

        // Close modal when clicking overlay
        document.getElementById('modalOverlay').addEventListener('click', closeNewSummaryModal);

        // Prevent modal from closing when clicking inside modal
        document.getElementById('newSummaryModal').addEventListener('click', function (e) {
            e.stopPropagation();
        });
    </script>
    <script th:src="@{/Static/js/L_activeMenu.js}"></script>
</body>

</html>