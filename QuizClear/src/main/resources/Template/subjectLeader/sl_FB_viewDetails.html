<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:,">    <link rel="stylesheet" th:href="@{/Static/fontawesome/css/all.css}">
    <link rel="stylesheet" th:href="@{/Static/header.css}">
    <link rel="stylesheet" th:href="@{/Static/web_styles.css}">
    <link rel="stylesheet" th:href="@{/Static/Menu-Staff.css}">
    <link rel="stylesheet" th:href="@{/Static/css/subjectLeader/sl_FB_viewDetails.css}">
    <link href="https://fonts.googleapis.com/css2?family=RocknRoll+One&display=swap" rel="stylesheet">
    <title>SL Plans</title>
</head>

<body>    <!-- Header -->
    <header class="header" th:insert="~{header_user :: header}"></header>

    <!-- Body -->
    <div id="Container-body">
        <!-- Menu -->
        <div class="sidebar" th:insert="~{subjectLeader/Menu-SL :: Menu-SL}"></div>

        <!-- Main content -->
        <div id="main">
            <div class="details-container">                <div class="page-header">
                    <a href="/subject-leader/feedback">
                        <button class="back-btn">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                    </a>
                    <h1>Details</h1>
                </div>

                <div class="information-section">
                    <h2>Information</h2>
                    <p class="section-subtitle">Display all related information</p>

                    <div class="info-grid">
                        <div class="info-row">
                            <div class="info-field">
                                <label>No.</label>
                                <input type="text" value="DB_S102" readonly>
                            </div>
                            <div class="info-field">
                                <label>Feedback Giver</label>
                                <input type="text" value="Department Head" readonly>
                            </div>
                        </div>

                        <div class="info-row">
                            <div class="info-field">
                                <label>Feedback Content</label>
                                <input type="text" value="Feedback on Q25" readonly>
                            </div>
                            <div class="info-field">
                                <label>Created Date</label>
                                <input type="text" value="23/4/25" readonly>
                            </div>
                        </div>

                        <div class="info-row">
                            <div class="info-field">
                                <label>Status</label>
                                <input type="text" value="Received" readonly>
                            </div>
                        </div>                        <div class="info-row">
                            <div class="info-field">
                                <label>Notes <span style="color: #666; font-size: 0.8em;">(Editable)</span></label>
                                <textarea placeholder="Enter your feedback notes here..." 
                                         style="border: 1px solid #ddd; background-color: #fafafa;"
                                         onchange="markNotesAsModified()"
                                         id="feedbackNotes"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="question-list-section">
                    <h2>Related Question</h2>
                    <p class="section-subtitle">Display the question and all related information</p>                    <div class="questions-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Question Content</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>
                                        <div>
                                            <span id="questionText">Question 25: In a redox reaction, which substance is
                                                the reducing agent?</span>
                                            <div class="question-options">
                                                <p>A. <span id="optionA">O2</span></p>
                                                <p>B. <span id="optionB">H2</span></p>
                                                <p>C. <span id="optionC">Cl2</span></p>
                                                <p>D. <span id="optionD">Fe2O3</span></p>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>                    <div class="action-buttons">
                        <button title="Edit Question Content" class="btn btn--edit"
                            onclick="openEditModal()">Edit</button>
                        <button title="Assign to Another Lecturer" class="btn btn--assign"
                            onclick="openAssignModal()">Assign</button>
                        <button title="Resubmit for Higher Review" class="btn btn--resubmit"
                            onclick="handleResubmit()">Resubmit</button>
                        <button title="Save Feedback Notes" class="btn btn--save-notes" 
                            onclick="saveFeedbackNotes()" 
                            id="saveNotesBtn" 
                            style="background: #28a745; display: none;">Save Notes</button>
                    </div>
                    
                    <!-- Status-dependent action message -->
                    <div id="actionMessage" class="action-message" style="display: none; text-align: center; padding: 1rem; margin: 1rem 0; background-color: #f8f9fa; border-radius: 0.5rem; color: #6c757d; font-style: italic;">
                        <!-- Message will be populated by JavaScript based on status -->
                    </div>
                </div>
            </div>
        </div>        <!-- Modal for New Assignment -->
        <div id="assignModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeAssignModal()">×</span>
                <h2 class="modal-title">Reassign Question</h2>
                <p style="color: #666; margin-bottom: 20px;">Assign this question to another lecturer for revision</p>

                <div class="modal-row">
                    <div class="modal-item">
                        <label class="modal-label">Target Department</label>
                        <select id="assignDepartment" class="modal-select" onchange="loadLecturersByDepartment()">
                            <option value="">Select Department</option>
                            <option value="CS">Computer Science</option>
                            <option value="MATH">Mathematics</option>
                            <option value="PHYS">Physics</option>
                            <option value="CHEM">Chemistry</option>
                            <option value="BIO">Biology</option>
                        </select>
                    </div>
                    <div class="modal-item">
                        <label class="modal-label">Assign to Lecturer</label>
                        <select id="assignLecturer" class="modal-select" disabled>
                            <option value="">First select department</option>
                        </select>
                    </div>
                </div>

                <div class="modal-row">
                    <div class="modal-item">
                        <label class="modal-label">Assign Date</label>
                        <input type="date" id="assignDate" class="modal-input" disabled>
                    </div>
                    <div class="modal-item">
                        <label class="modal-label">Due Date</label>
                        <input type="date" id="assignDueDate" class="modal-input" value="2025-07-20">
                    </div>
                </div>

                <div class="modal-notes">
                    <label class="modal-label">Assignment Instructions</label>
                    <textarea id="assignNotes" class="modal-input" rows="3" placeholder="Please review and improve this question. Focus on: clarity, difficulty level, answer options..."></textarea>
                </div>

                <div class="modal-buttons">
                    <button class="modal-btn modal-btn--cancel" onclick="closeAssignModal()">Cancel</button>
                    <button class="modal-btn modal-btn--assign" onclick="handleAssignment()">Reassign</button>
                </div>
            </div>
        </div>

        <!-- Modal for Edit Question -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeEditModal()">×</span>
                <h2 class="modal-title">Edit</h2>

                <div class="modal-item">
                    <label class="modal-label">Question</label>
                    <textarea id="editQuestionText" class="modal-textarea"></textarea>
                </div>

                <div class="modal-item" style="display: flex;flex-direction: row;gap:1rem">
                    <div class ="answer-contain">
                        <label class="modal-label">Answers</label>
                        <div class="edit-options">
                            <div class="option-row">
                                <span class="option-label">A.</span>
                                <input type="text" id="editOptionA" class="modal-input option-input"
                                    style="border: none;">
                            </div>
                            <div class="option-row">
                                <span class="option-label">B.</span>
                                <input type="text" id="editOptionB" class="modal-input option-input"
                                    style="border: none;">
                            </div>
                            <div class="option-row">
                                <span class="option-label">C.</span>
                                <input type="text" id="editOptionC" class="modal-input option-input"
                                    style="border: none;">
                            </div>
                            <div class="option-row">
                                <span class="option-label">D.</span>
                                <input type="text" id="editOptionD" class="modal-input option-input"
                                    style="border: none;">
                            </div>
                        </div>
                    </div>
                    <div class="modal-item">
                        <label class="modal-label">Correct Answer</label>
                        <select id="correctAnswer" class="modal-select">
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                        </select>
                    </div>
                </div>



                <div class="modal-buttons">
                    <button class="modal-btn modal-btn--cancel" onclick="closeEditModal()">Cancel</button>
                    <button class="modal-btn modal-btn--save" onclick="saveQuestion()">Save</button>
                </div>
            </div>
        </div>
    </div>    <!-- Scripts for loading header, menu, and modal functionality -->
    <script>
        // Global variables
        let currentFeedbackId = null;
        let currentFeedbackType = null;
        let currentFeedbackData = null;

        // Get URL parameters
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);        }        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // For path: /subject-leader/feedback/{id}/details?type={type}
            // Extract ID from path
            const pathSegments = window.location.pathname.split('/');
            const feedbackIndex = pathSegments.indexOf('feedback');
            if (feedbackIndex >= 0 && pathSegments[feedbackIndex + 1]) {
                currentFeedbackId = pathSegments[feedbackIndex + 1];
            }
            
            // Get type from URL parameters
            currentFeedbackType = getUrlParameter('type');
            
            if (currentFeedbackId) {
                loadFeedbackDetail(currentFeedbackId);
            } else {
                showErrorMessage('No feedback ID provided');
            }
        });// Load feedback detail data
        function loadFeedbackDetail(feedbackId) {
            let apiUrl = `/subject-leader/api/feedback/${feedbackId}`;
            if (currentFeedbackType) {
                apiUrl += `?type=${currentFeedbackType}`;
            }
            
            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    currentFeedbackData = data;
                    populateFeedbackDetail(data);
                })
                .catch(error => {
                    console.error('Error loading feedback detail:', error);
                    showErrorMessage('Error loading feedback data. Please try again.');
                });
        }

        // Populate feedback detail form
        function populateFeedbackDetail(data) {
            if (!data) {
                showErrorMessage('No feedback data found');
                return;
            }

            // Update information section
            const infoInputs = document.querySelectorAll('.info-field input, .info-field textarea');
            
            // No. field
            const noInput = infoInputs[0];
            if (noInput) {
                noInput.value = `${data.type === 'exam' ? 'EX' : 'Q'}_${data.id}`;
            }

            // Feedback Giver field
            const giverInput = infoInputs[1];
            if (giverInput) {
                giverInput.value = data.reviewedByName || data.createdByName || 'Unknown';
            }

            // Feedback Content field
            const contentInput = infoInputs[2];
            if (contentInput) {
                const shortContent = data.title && data.title.length > 50 ? 
                                   data.title.substring(0, 50) + '...' : 
                                   (data.title || 'No content');
                contentInput.value = shortContent;
            }            // Created Date field
            const dateInput = infoInputs[3];
            if (dateInput) {
                let formattedDate = 'N/A';
                let dateToFormat = null;
                
                // Priority: submittedAt > createdAt > reviewedAt
                if (data.submittedAt) {
                    dateToFormat = new Date(data.submittedAt);
                } else if (data.createdAt) {
                    dateToFormat = new Date(data.createdAt);
                } else if (data.reviewedAt) {
                    dateToFormat = new Date(data.reviewedAt);
                }
                
                if (dateToFormat && !isNaN(dateToFormat.getTime())) {
                    formattedDate = dateToFormat.toLocaleDateString('en-GB', {
                        day: '2-digit',
                        month: '2-digit',
                        year: '2-digit'
                    });
                }
                dateInput.value = formattedDate;
            }// Status field
            const statusInput = infoInputs[4];
            if (statusInput) {
                // Display the actual status from backend
                statusInput.value = data.status || 'Unknown';
            }            // Notes field
            const notesTextarea = document.querySelector('.info-field textarea');
            if (notesTextarea) {
                notesTextarea.value = data.feedback || '';
                notesTextarea.setAttribute('data-original', data.feedback || '');
            }            // Update question content if it's a question
            if (data.type === 'question') {
                populateQuestionContent(data);
            } else if (data.type === 'exam') {
                populateExamContent(data);
            }
            
            // Update action buttons based on status
            updateActionButtons(data.status);
        }
          // Update action buttons based on feedback status
        function updateActionButtons(status) {
            const editBtn = document.querySelector('.btn--edit');
            const assignBtn = document.querySelector('.btn--assign');
            const resubmitBtn = document.querySelector('.btn--resubmit');
            const actionMessage = document.getElementById('actionMessage');
            
            // Hide all buttons by default
            if (editBtn) editBtn.style.display = 'none';
            if (assignBtn) assignBtn.style.display = 'none';
            if (resubmitBtn) resubmitBtn.style.display = 'none';
            if (actionMessage) actionMessage.style.display = 'none';
            
            // Show buttons based on status
            if (status) {
                const upperStatus = status.toUpperCase();
                
                switch(upperStatus) {
                    case 'REJECTED':
                        // For rejected: can edit and reassign
                        if (editBtn) editBtn.style.display = 'inline-block';
                        if (assignBtn) assignBtn.style.display = 'inline-block';
                        if (actionMessage) {
                            actionMessage.innerHTML = '📝 This question was rejected. You can edit it directly or assign it to another lecturer for revision.';
                            actionMessage.style.display = 'block';
                            actionMessage.style.borderLeft = '4px solid #dc3545';
                        }
                        break;
                        
                    case 'SUBMITTED':
                    case 'SUBMITTED_FOR_REVIEW':
                        // For submitted: can edit, assign, or resubmit for higher review
                        if (editBtn) editBtn.style.display = 'inline-block';
                        if (assignBtn) assignBtn.style.display = 'inline-block';
                        if (resubmitBtn) resubmitBtn.style.display = 'inline-block';
                        if (actionMessage) {
                            actionMessage.innerHTML = '⏳ This question is awaiting review. You can edit, reassign, or escalate it for higher-level review.';
                            actionMessage.style.display = 'block';
                            actionMessage.style.borderLeft = '4px solid #ffc107';
                        }
                        break;
                        
                    case 'APPROVED':
                        // For approved: no actions needed (already processed)
                        if (actionMessage) {
                            actionMessage.innerHTML = '✅ This question has been approved. No further actions are required.';
                            actionMessage.style.display = 'block';
                            actionMessage.style.borderLeft = '4px solid #28a745';
                        }
                        break;
                        
                    default:
                        // For unknown status: show all options
                        if (editBtn) editBtn.style.display = 'inline-block';
                        if (assignBtn) assignBtn.style.display = 'inline-block';
                        if (resubmitBtn) resubmitBtn.style.display = 'inline-block';
                        if (actionMessage) {
                            actionMessage.innerHTML = '❓ Status unknown. All actions are available.';
                            actionMessage.style.display = 'block';
                            actionMessage.style.borderLeft = '4px solid #6c757d';
                        }
                }
            }
        }

        // Populate question content
        function populateQuestionContent(data) {
            const questionText = document.getElementById('questionText');
            const optionA = document.getElementById('optionA');
            const optionB = document.getElementById('optionB');
            const optionC = document.getElementById('optionC');
            const optionD = document.getElementById('optionD');

            if (questionText && data.content) {
                questionText.innerText = data.content;
            }

            if (optionA && data.answerF1) optionA.innerText = data.answerF1;
            if (optionB && data.answerF2) optionB.innerText = data.answerF2;
            if (optionC && data.answerF3) optionC.innerText = data.answerF3;
            if (optionD && data.answerKey) optionD.innerText = data.answerKey;

            // Update table header for question
            const tableHeader = document.querySelector('.questions-table th');
            if (tableHeader) {
                tableHeader.textContent = 'Question Content';
            }
        }

        // Populate exam content (if needed)
        function populateExamContent(data) {
            const questionText = document.getElementById('questionText');
            
            if (questionText && data.content) {
                questionText.innerText = `Exam: ${data.title}`;
            }

            // Hide options for exam
            const questionOptions = document.querySelector('.question-options');
            if (questionOptions) {
                questionOptions.style.display = 'none';
            }

            // Update table header for exam
            const tableHeader = document.querySelector('.questions-table th');
            if (tableHeader) {
                tableHeader.textContent = 'Exam Content';
            }
        }

        // Show error message
        function showErrorMessage(message) {
            const mainContainer = document.querySelector('.details-container');
            if (mainContainer) {
                mainContainer.innerHTML = `
                    <div style="text-align: center; padding: 50px; color: #666;">
                        <h2>Error</h2>
                        <p>${message}</p>
                        <a href="sl_feedBack.html" style="color: #007bff; text-decoration: none;">
                            ← Back to Feedback List
                        </a>
                    </div>
                `;
            }
        }        // Function to format date to YYYY-MM-DD
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-based
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Notes management functions
        function markNotesAsModified() {
            const notesTextarea = document.getElementById('feedbackNotes') || document.querySelector('.info-field textarea');
            const saveNotesBtn = document.getElementById('saveNotesBtn');
            
            if (notesTextarea && saveNotesBtn) {
                const originalNotes = notesTextarea.getAttribute('data-original') || '';
                const currentNotes = notesTextarea.value.trim();
                
                if (currentNotes !== originalNotes) {
                    saveNotesBtn.style.display = 'inline-block';
                    notesTextarea.style.borderColor = '#ffc107';
                    notesTextarea.style.backgroundColor = '#fff8e1';
                } else {
                    saveNotesBtn.style.display = 'none';
                    notesTextarea.style.borderColor = '#ddd';
                    notesTextarea.style.backgroundColor = '#fafafa';
                }
            }
        }

        function saveFeedbackNotes() {
            const notesTextarea = document.getElementById('feedbackNotes') || document.querySelector('.info-field textarea');
            
            if (!notesTextarea) {
                alert('Error: Could not find notes field');
                return;
            }

            const feedbackNotes = notesTextarea.value.trim();
            
            if (!currentFeedbackId) {
                alert('Error: No feedback ID found');
                return;
            }

            const notesData = {
                feedback: feedbackNotes,
                updatedBy: 'Subject Leader'
            };

            fetch(`/subject-leader/api/feedback/${currentFeedbackId}/update-notes`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(notesData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('✅ Feedback notes saved successfully!');
                    
                    // Update original data
                    notesTextarea.setAttribute('data-original', feedbackNotes);
                    if (currentFeedbackData) {
                        currentFeedbackData.feedback = feedbackNotes;
                    }
                    
                    // Reset visual indicators
                    const saveNotesBtn = document.getElementById('saveNotesBtn');
                    if (saveNotesBtn) {
                        saveNotesBtn.style.display = 'none';
                    }
                    notesTextarea.style.borderColor = '#28a745';
                    notesTextarea.style.backgroundColor = '#f8fff9';
                    
                    // Reset to normal after 2 seconds
                    setTimeout(() => {
                        notesTextarea.style.borderColor = '#ddd';
                        notesTextarea.style.backgroundColor = '#fafafa';
                    }, 2000);
                    
                } else {
                    alert('❌ Error saving notes:\n' + (data.message || 'Unknown error occurred'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('❌ Network Error:\nFailed to save notes. Please check your connection and try again.');
            });
        }// Assign Modal functionality
        function openAssignModal() {
            // Check if assigning is allowed for current status
            if (currentFeedbackData) {
                const status = currentFeedbackData.status ? currentFeedbackData.status.toUpperCase() : '';
                if (status === 'APPROVED') {
                    alert('Cannot reassign an approved question. The question has already been processed.');
                    return;
                }
            }
            
            // Set Assign Date to current date
            const assignDateInput = document.getElementById('assignDate');
            const currentDate = new Date();
            assignDateInput.value = formatDate(currentDate);

            // Reset form
            document.getElementById('assignDepartment').value = '';
            document.getElementById('assignLecturer').innerHTML = '<option value="">First select department</option>';
            document.getElementById('assignLecturer').disabled = true;
            document.getElementById('assignNotes').value = '';

            // Show the modal
            document.getElementById('assignModal').style.display = 'block';
        }

        function closeAssignModal() {
            document.getElementById('assignModal').style.display = 'none';
        }

        // Load lecturers based on selected department
        function loadLecturersByDepartment() {
            const departmentSelect = document.getElementById('assignDepartment');
            const lecturerSelect = document.getElementById('assignLecturer');
            
            if (!departmentSelect.value) {
                lecturerSelect.innerHTML = '<option value="">First select department</option>';
                lecturerSelect.disabled = true;
                return;
            }

            // Mock data - in real app, this would fetch from API
            const lecturersByDepartment = {
                'CS': [
                    { id: 1, name: 'Ash Abrahams', email: 'ash.abrahams@university.edu' },
                    { id: 3, name: 'Brian Carter', email: 'brian.carter@university.edu' }
                ],
                'MATH': [
                    { id: 7, name: 'Frank Green', email: 'frank.green@university.edu' },
                    { id: 8, name: 'Grace Harris', email: 'grace.harris@university.edu' }
                ],
                'PHYS': [
                    { id: 6, name: 'Emily Foster', email: 'emily.foster@university.edu' }
                ],
                'CHEM': [
                    { id: 9, name: 'Henry Johnson', email: 'henry.johnson@university.edu' }
                ],
                'BIO': [
                    { id: 5, name: 'Daniel Evans', email: 'daniel.evans@university.edu' },
                    { id: 10, name: 'Isabella King', email: 'isabella.king@university.edu' }
                ]
            };

            const lecturers = lecturersByDepartment[departmentSelect.value] || [];
            
            lecturerSelect.innerHTML = '<option value="">Select Lecturer</option>';
            lecturers.forEach(lecturer => {
                lecturerSelect.innerHTML += `<option value="${lecturer.id}">${lecturer.name} (${lecturer.email})</option>`;
            });
            
            lecturerSelect.disabled = false;
        }        // Handle assignment submission
        function handleAssignment() {
            // Get form values
            const departmentSelect = document.getElementById('assignDepartment');
            const lecturerSelect = document.getElementById('assignLecturer');
            const dueDateInput = document.getElementById('assignDueDate');
            const notesInput = document.getElementById('assignNotes');

            // Validation
            if (!departmentSelect.value) {
                alert('Please select a target department');
                return;
            }
            
            if (!lecturerSelect.value) {
                alert('Please select a lecturer to assign to');
                return;
            }
            
            if (!dueDateInput.value) {
                alert('Please set a due date');
                return;
            }

            const assignmentData = {
                targetDepartment: departmentSelect.value,
                assignToLecturerId: lecturerSelect.value,
                dueDate: dueDateInput.value,
                instructions: notesInput.value.trim() || 'Please review and improve this question.',
                currentQuestionId: currentFeedbackId,
                assignedBy: 'Subject Leader' // This would come from session in real app
            };

            if (!currentFeedbackId) {
                alert('Error: No question ID found');
                return;
            }

            // Confirm assignment
            const selectedLecturer = lecturerSelect.options[lecturerSelect.selectedIndex].text;
            const confirmMessage = `Are you sure you want to reassign this question to:\n\n` +
                                 `Lecturer: ${selectedLecturer}\n` +
                                 `Department: ${departmentSelect.options[departmentSelect.selectedIndex].text}\n` +
                                 `Due Date: ${dueDateInput.value}\n\n` +
                                 `The question will be moved to the assigned lecturer for revision.`;
            
            if (!confirm(confirmMessage)) {
                return;
            }

            fetch(`/subject-leader/api/feedback/${currentFeedbackId}/assign`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(assignmentData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('✅ Question successfully reassigned!\n\n' +
                          `The question has been assigned to ${selectedLecturer} ` +
                          `for revision. They will receive a notification with ` +
                          `your instructions and the due date.`);
                    closeAssignModal();
                      // Update status display
                    const statusInput = document.querySelector('.info-field input[readonly]');
                    if (statusInput && statusInput.parentElement.querySelector('label').textContent === 'Status') {
                        statusInput.value = 'REASSIGNED';
                    }
                    
                    // Update current feedback data
                    if (currentFeedbackData) {
                        currentFeedbackData.status = 'REASSIGNED';
                    }
                      // Optional: redirect back to feedback list
                    setTimeout(() => {
                        if (confirm('✅ Question assigned successfully!\n\n' +
                                  'The question has been reassigned to another lecturer for revision. ' +
                                  'It will no longer appear in your feedback list since it\'s now under the assigned lecturer\'s responsibility.\n\n' +
                                  'Do you want to return to feedback list?')) {
                            window.location.href = '/subject-leader/feedback';
                        }
                    }, 1500);
                    
                } else {
                    alert('❌ Error assigning question:\n' + (data.message || 'Unknown error occurred'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('❌ Network Error:\nFailed to assign question. Please check your connection and try again.');
            });
        }        // Edit Modal functionality
        function openEditModal() {
            if (!currentFeedbackData || currentFeedbackData.type !== 'question') {
                alert('Edit is only available for questions');
                return;
            }
            
            // Check if editing is allowed for current status
            const status = currentFeedbackData.status ? currentFeedbackData.status.toUpperCase() : '';
            if (status === 'APPROVED') {
                alert('Cannot edit an approved question. The question has already been processed.');
                return;
            }

            // Populate modal with current question data
            document.getElementById('editQuestionText').value = currentFeedbackData.content || '';
            document.getElementById('editOptionA').value = currentFeedbackData.answerF1 || '';
            document.getElementById('editOptionB').value = currentFeedbackData.answerF2 || '';
            document.getElementById('editOptionC').value = currentFeedbackData.answerF3 || '';
            document.getElementById('editOptionD').value = currentFeedbackData.answerKey || '';

            // Set correct answer based on answerKey
            const correctAnswerSelect = document.getElementById('correctAnswer');
            if (correctAnswerSelect && currentFeedbackData.answerKey) {
                // Try to determine which option matches the answerKey
                if (currentFeedbackData.answerKey === currentFeedbackData.answerF1) {
                    correctAnswerSelect.value = 'A';
                } else if (currentFeedbackData.answerKey === currentFeedbackData.answerF2) {
                    correctAnswerSelect.value = 'B';
                } else if (currentFeedbackData.answerKey === currentFeedbackData.answerF3) {
                    correctAnswerSelect.value = 'C';
                } else {
                    correctAnswerSelect.value = 'D'; // Default to D if answerKey doesn't match any option
                }
            }

            // Show the modal
            document.getElementById('editModal').style.display = 'block';
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }        function saveQuestion() {
            if (!currentFeedbackId) {
                alert('Error: No feedback ID found');
                return;
            }

            // Get current form data
            const questionData = {
                content: document.getElementById('editQuestionText').value.trim(),
                answerF1: document.getElementById('editOptionA').value.trim(),
                answerF2: document.getElementById('editOptionB').value.trim(),
                answerF3: document.getElementById('editOptionC').value.trim(),
                correctAnswer: document.getElementById('correctAnswer').value
            };

            // Validation: Check if all fields are filled
            if (!questionData.content) {
                alert('Please enter question content');
                return;
            }
            if (!questionData.answerF1 || !questionData.answerF2 || !questionData.answerF3) {
                alert('Please fill in all answer options (A, B, C)');
                return;
            }

            // Set answerKey based on correct answer selection
            switch(questionData.correctAnswer) {
                case 'A':
                    questionData.answerKey = questionData.answerF1;
                    break;
                case 'B':
                    questionData.answerKey = questionData.answerF2;
                    break;
                case 'C':
                    questionData.answerKey = questionData.answerF3;
                    break;
                case 'D':
                    const optionD = document.getElementById('editOptionD').value.trim();
                    if (!optionD) {
                        alert('Please fill in answer option D');
                        return;
                    }
                    questionData.answerKey = optionD;
                    break;
            }

            // Check if there are actual changes
            const hasChanges = currentFeedbackData && (
                questionData.content !== currentFeedbackData.content ||
                questionData.answerF1 !== currentFeedbackData.answerF1 ||
                questionData.answerF2 !== currentFeedbackData.answerF2 ||
                questionData.answerF3 !== currentFeedbackData.answerF3 ||
                questionData.answerKey !== currentFeedbackData.answerKey
            );

            if (!hasChanges) {
                alert('No changes detected. Please make changes before saving.');
                return;
            }

            fetch(`/subject-leader/api/feedback/${currentFeedbackId}/update-question`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(questionData)
            })            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('✅ Question updated and approved successfully!\n' +
                          'Changes have been saved and the question has been approved.');
                    closeEditModal();
                    
                    // Update the display with new values
                    document.getElementById('questionText').innerText = questionData.content;
                    document.getElementById('optionA').innerText = questionData.answerF1;
                    document.getElementById('optionB').innerText = questionData.answerF2;
                    document.getElementById('optionC').innerText = questionData.answerF3;
                    document.getElementById('optionD').innerText = questionData.answerKey;
                    
                    // Update status to approved
                    const statusInput = document.querySelector('.info-field input[readonly]');
                    if (statusInput && statusInput.parentElement.querySelector('label').textContent === 'Status') {
                        statusInput.value = 'APPROVED';
                    }
                    
                    // Update current data for future comparisons
                    if (currentFeedbackData) {
                        currentFeedbackData.content = questionData.content;
                        currentFeedbackData.answerF1 = questionData.answerF1;
                        currentFeedbackData.answerF2 = questionData.answerF2;
                        currentFeedbackData.answerF3 = questionData.answerF3;
                        currentFeedbackData.answerKey = questionData.answerKey;
                        currentFeedbackData.status = 'APPROVED';
                    }
                      // Optional: redirect back to feedback list after a delay
                    setTimeout(() => {
                        if (confirm('✅ Question approved successfully!\n\n' +
                                  'The question has been edited and automatically approved. ' +
                                  'It will no longer appear in your pending feedback list since it has been processed.\n\n' +
                                  'Do you want to return to feedback list?')) {
                            window.location.href = '/subject-leader/feedback';
                        }
                    }, 1000);
                    
                } else {
                    alert('❌ Error updating question:\n' + (data.message || 'Unknown error occurred'));
                }            })
            .catch(error => {
                console.error('Error:', error);
                alert('❌ Network Error:\nFailed to update question. Please check your connection and try again.');
            });
        }

        // Resubmit functionality
        function handleResubmit() {
            if (!currentFeedbackId) {
                alert('Error: No question ID found');
                return;
            }
            
            // Check if resubmitting is allowed for current status
            if (currentFeedbackData) {
                const status = currentFeedbackData.status ? currentFeedbackData.status.toUpperCase() : '';
                if (status === 'APPROVED') {
                    alert('Cannot resubmit an approved question. The question has already been processed.');
                    return;
                }
                if (status === 'REJECTED') {
                    alert('This question was rejected. Please edit it or reassign it instead of resubmitting.');
                    return;
                }
            }

            // Get current notes for resubmission
            const notesTextarea = document.querySelector('.info-field textarea');
            const resubmitNotes = notesTextarea ? notesTextarea.value.trim() : '';

            const confirmMessage = `Are you sure you want to resubmit this question for higher-level review?\n\n` +
                                 `This action will:\n` +
                                 `• Send the question to Head of Education Department\n` +
                                 `• Include your feedback notes for context\n` +
                                 `• Change status to "SUBMITTED_FOR_REVIEW"\n\n` +
                                 `Current feedback notes:\n"${resubmitNotes || 'No notes provided'}"`;

            if (!confirm(confirmMessage)) {
                return;
            }

            const resubmitData = {
                feedback: resubmitNotes,
                submittedBy: 'Subject Leader',
                submissionReason: 'Escalation for higher-level review'
            };

            fetch(`/subject-leader/api/feedback/${currentFeedbackId}/resubmit`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(resubmitData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('✅ Question resubmitted successfully!\n\n' +
                          'The question has been escalated to Head of Education Department ' +
                          'for final review. You will be notified of their decision.');
                    
                    // Update status display
                    const statusInput = document.querySelector('.info-field input[readonly]');
                    if (statusInput && statusInput.parentElement.querySelector('label').textContent === 'Status') {
                        statusInput.value = 'SUBMITTED_FOR_REVIEW';
                    }
                      // Optional: redirect back to feedback list
                    setTimeout(() => {
                        if (confirm('✅ Question resubmitted successfully!\n\n' +
                                  'The question has been escalated to Head of Education Department for final review. ' +
                                  'It will no longer appear in your feedback list since it\'s now under higher-level review.\n\n' +
                                  'Do you want to return to feedback list?')) {
                            window.location.href = '/subject-leader/feedback';
                        }
                    }, 1500);
                      } else {
                    alert('❌ Error resubmitting question:\n' + (data.message || 'Unknown error occurred'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('❌ Network Error:\nFailed to resubmit question. Please check your connection and try again.');
            });
        }
        
        // Close modals when clicking outside of them
        window.onclick = function (event) {
            const assignModal = document.getElementById('assignModal');
            const editModal = document.getElementById('editModal');            if (event.target == assignModal) {
                assignModal.style.display = 'none';
            }
            if (event.target == editModal) {
                editModal.style.display = 'none';
            }
        };
        
        // Add event listeners when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Assign button event listener
            const assignButton = document.querySelector('.modal-btn--assign');
            if (assignButton) {
                assignButton.addEventListener('click', handleAssignment);
            }

            // Resubmit button event listener
            const resubmitButton = document.querySelector('.btn--resubmit');
            if (resubmitButton) {
                resubmitButton.addEventListener('click', handleResubmit);
            }

            // Notes change event listener
            const notesTextarea = document.querySelector('.info-field textarea');
            if (notesTextarea) {
                notesTextarea.addEventListener('input', markNotesAsModified);
                notesTextarea.addEventListener('change', markNotesAsModified);
            }
        });
    </script>
    <script th:src="@{/Static/js/L_activeMenu.js}"></script>
</body>

</html>