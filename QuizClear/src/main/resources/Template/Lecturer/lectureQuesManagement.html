<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <link rel="stylesheet" th:href="@{/Static/fontawesome/css/all.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/Static/header.css}">
    <link rel="stylesheet" th:href="@{/Static/web_styles.css}">
    <link rel="stylesheet" th:href="@{/Static/Menu-Staff.css}">
    <link rel="stylesheet" th:href="@{/Static/css/Lecturer/lectureQuesManagement.css}">
    <link href="https://fonts.googleapis.com/css2?family=RocknRoll+One&display=swap" rel="stylesheet">
    <title>QuestionManager</title>
</head>    <body class="question-management-page">
        <!-- Header using Thymeleaf fragment like other pages -->
        <div th:replace="~{header_user :: header}"></div>

        <div id="Container-body">
            <!-- Menu using Thymeleaf fragment -->
            <div th:replace="~{Lecturer/Menu-Lecturer :: menu}"></div>

        <div id="main">
            <div class="question-management-header">
                <h1>Question Management</h1>                <a href="/lecturer/create-question">
                    <button class="create-question-button">
                        <i class="fas fa-plus"></i>
                        Create Question
                    </button>
                </a>
            </div>

            <div class="navigation-tabs">
                <button class="tab-button active">Current Assignment</button>
                <button class="tab-button">Progress Tracking</button>
            </div>

            <div id="Current_assignment">                <div class="filters">                    <div class="filter-dropdown">
                        <select>
                            <option value="">All difficulty</option>
                            <option value="recognition">Remember</option>
                            <option value="comprehension">Understand</option>
                            <option value="basic_application">Apply (Basic)</option>
                            <option value="advanced_application">Apply (Advanced)</option>
                        </select>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="filter-dropdown">
                        <select>
                            <option value="">All subject</option>
                            <!-- Subjects will be loaded dynamically -->
                        </select>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="filter-dropdown">
                        <select>
                            <option value="">All status</option>
                            <option value="draft">Draft</option>
                            <option value="submitted">Submitted</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                            <option value="archived">Archived</option>
                            <option value="declined">Declined</option>
                        </select>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                </div>

                <div class="question-table-container">
                    <table class="question-table">
                        <thead>
                            <tr>
                                <th>Subject</th>
                                <th>Question</th>
                                <th>Correct Answer</th>
                                <th>Other Answer</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>DataBase System</td>
                                <td>Which data structure would be most efficient for implementing a priority queue?</td>
                                <td>This is correct answers</td>
                                <td>
                                    • False 1<br>
                                    • False 2<br>
                                    • False 3
                                </td>
                                <td class="status-cell">
                                    <div class="status-buttons">
                                        <button class="action-button remember">Remember</button>
                                        <button class="action-button save">Save</button>
                                    </div>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <a href="/lecturer/edit-question"><button class="circle-button delete editQuestion"><i class="fa-solid fa-pen-to-square"></i></button></a>
                                        <button class="circle-button delete"><i class="fas fa-trash-alt"></i></button>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>DataBase System</td>
                                <td>Which data structure would be most efficient for implementing a priority queue?</td>
                                <td>This is correct answers</td>
                                <td>
                                    • False 1<br>
                                    • False 2<br>
                                    • False 3
                                </td>
                                <td class="status-cell">
                                    <div class="status-buttons">
                                        <button class="action-button remember">Remember</button>
                                        <button class="action-button drop">Drop</button>
                                    </div>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <a href="/lecturer/edit-question"><button class="circle-button delete editQuestion"><i class="fa-solid fa-pen-to-square"></i></button></a>
                                        <button class="circle-button delete"><i class="fas fa-trash-alt"></i></button>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>DataBase System</td>
                                <td>Which data structure would be most efficient for implementing a priority queue?</td>
                                <td>This is correct answers</td>
                                <td>
                                    • False 1<br>
                                    • False 2<br>
                                    • False 3
                                </td>
                                <td class="status-cell">
                                    <div class="status-buttons">
                                        <button class="action-button remember">Remember</button>
                                        <button class="action-button save">Save</button>
                                    </div>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <a href="/lecturer/edit-question"><button class="circle-button delete editQuestion"><i class="fa-solid fa-pen-to-square"></i></button></a>
                                        <button class="circle-button delete"><i class="fas fa-trash-alt"></i></button>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>DataBase System</td>
                                <td>Which data structure would be most efficient for implementing a priority queue?</td>
                                <td>This is correct answers</td>
                                <td>
                                    • False 1<br>
                                    • False 2<br>
                                    • False 3
                                </td>
                                <td class="status-cell">
                                    <div class="status-buttons">
                                        <button class="action-button remember">Remember</button>
                                        <button class="action-button drop">Drop</button>
                                    </div>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <a href="/lecturer/edit-question"><button class="circle-button delete editQuestion"><i class="fa-solid fa-pen-to-square"></i></button></a>
                                        <button class="circle-button delete"><i class="fas fa-trash-alt"></i></button>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>DataBase System</td>
                                <td>Which data structure would be most efficient for implementing a priority queue?</td>
                                <td>This is correct answers</td>
                                <td>
                                    • False 1<br>
                                    • False 2<br>
                                    • False 3
                                </td>
                                <td class="status-cell">
                                    <div class="status-buttons">
                                        <button class="action-button remember">Remember</button>
                                        <button class="action-button save">Save</button>
                                    </div>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <a href="/lecturer/edit-question"><button class="circle-button delete editQuestion"><i class="fa-solid fa-pen-to-square"></i></button></a>
                                        <button class="circle-button delete"><i class="fas fa-trash-alt"></i></button>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>DataBase System</td>
                                <td>Which data structure would be most efficient for implementing a priority queue?</td>
                                <td>This is correct answers</td>
                                <td>
                                    • False 1<br>
                                    • False 2<br>
                                    • False 3
                                </td>
                                <td class="status-cell">
                                    <div class="status-buttons">
                                        <button class="action-button remember">Remember</button>
                                        <button class="action-button drop">Drop</button>
                                    </div>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <a href="/lecturer/edit-question"><button class="circle-button delete editQuestion"><i class="fa-solid fa-pen-to-square"></i></button></a>
                                        <button class="circle-button delete"><i class="fas fa-trash-alt"></i></button>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>DataBase System</td>
                                <td>Which data structure would be most efficient for implementing a priority queue?</td>
                                <td>This is correct answers</td>
                                <td>
                                    • False 1<br>
                                    • False 2<br>
                                    • False 3
                                </td>
                                <td class="status-cell">
                                    <div class="status-buttons">
                                        <button class="action-button remember">Remember</button>
                                        <button class="action-button save">Save</button>
                                    </div>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <a href="/lecturer/edit-question"><button class="circle-button delete editQuestion"><i class="fa-solid fa-pen-to-square"></i></button></a>
                                        <button class="circle-button delete"><i class="fas fa-trash-alt"></i></button>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>DataBase System</td>
                                <td>Which data structure would be most efficient for implementing a priority queue?</td>
                                <td>This is correct answers</td>
                                <td>
                                    • False 1<br>
                                    • False 2<br>
                                    • False 3
                                </td>
                                <td class="status-cell">
                                    <div class="status-buttons">
                                        <button class="action-button remember">Remember</button>
                                        <button class="action-button drop">Drop</button>
                                    </div>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <a href="/lecturer/edit-question"><button class="circle-button delete editQuestion"><i class="fa-solid fa-pen-to-square"></i></button></a>
                                        <button class="circle-button delete"><i class="fas fa-trash-alt"></i></button>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>DataBase System</td>
                                <td>Which data structure would be most efficient for implementing a priority queue?</td>
                                <td>This is correct answers</td>
                                <td>
                                    • False 1<br>
                                    • False 2<br>
                                    • False 3
                                </td>
                                <td class="status-cell">
                                    <div class="status-buttons">
                                        <button class="action-button remember">Remember</button>
                                        <button class="action-button save">Save</button>
                                    </div>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <a href="/lecturer/edit-question"><button class="circle-button delete editQuestion"><i class="fa-solid fa-pen-to-square"></i></button></a>
                                        <button class="circle-button delete"><i class="fas fa-trash-alt"></i></button>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>DataBase System</td>
                                <td>Which data structure would be most efficient for implementing a priority queue?</td>
                                <td>This is correct answers</td>
                                <td>
                                    • False 1<br>
                                    • False 2<br>
                                    • False 3
                                </td>
                                <td class="status-cell">
                                    <div class="status-buttons">
                                        <button class="action-button remember">Remember</button>
                                        <button class="action-button drop">Drop</button>
                                    </div>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <a href="/lecturer/edit-question"><button class="circle-button delete editQuestion"><i class="fa-solid fa-pen-to-square"></i></button></a>
                                        <button class="circle-button delete"><i class="fas fa-trash-alt"></i></button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div id="Progress_tracking">
                <div id="map-container">
                    <div id="Question_Progress_container">
                        <p style="font-size: 1.625rem; font-weight: bolder; margin-bottom: 0.625rem;">Questions by Level
                        </p>
                        <div id="Question_Progress"
                            style="display: flex; flex-direction: row; height: 18.75rem;margin-top: 2.5rem">
                            <!-- Trục Y -->
                            <div class="y-axis">
                                <span>100</span>
                                <span>80</span>
                                <span>60</span>
                                <span>40</span>
                                <span>20</span>
                                <span>0</span>
                            </div>
                            <!-- Khu vực cột và đường kẻ -->
                            <div class="chart-content">
                                <div class="grid-overlay">
                                    <div class="bars" id="bars">
                                        <div class="bar-group">
                                            <div class="bar remember"><span class="tooltip">8%</span></div>
                                        </div>
                                        <div class="bar-group">
                                            <div class="bar understand"><span class="tooltip">80%</span></div>
                                        </div>
                                        <div class="bar-group">
                                            <div class="bar applying"><span class="tooltip">8%</span></div>
                                        </div>
                                        <div class="bar-group">
                                            <div class="bar analyzing"><span class="tooltip">3%</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Phần chú thích (legend) -->
                        <div class="legend" style="display: flex; justify-content: center; margin-top: 0.625rem;">
                            <div style="display: flex; align-items: center; margin: 0 0.625rem;">
                                <span class="legend-color remember"
                                    style="width: 0.9375rem; height: 0.9375rem; background-color: #00BFFF; display: inline-block; margin-right: 0.3125rem;"></span>
                                Remember
                            </div>
                            <div style="display: flex; align-items: center; margin: 0 0.625rem;">
                                <span class="legend-color understand"
                                    style="width: 0.9375rem; height: 0.9375rem; background-color: #5EF05E; display: inline-block; margin-right: 0.3125rem;"></span>
                                Understand
                            </div>
                            <div style="display: flex; align-items: center; margin: 0 0.625rem;">
                                <span class="legend-color applying"
                                    style="width: 0.9375rem; height: 0.9375rem; background-color: #FF7D03; display: inline-block; margin-right: 0.3125rem;"></span>
                                Applying
                            </div>
                            <div style="display: flex; align-items: center; margin: 0 0.625rem;">
                                <span class="legend-color analyzing"
                                    style="width: 0.9375rem; height: 0.9375rem; background-color: #F25B5B; display: inline-block; margin-right: 0.3125rem;"></span>
                                Analyzing
                            </div>
                        </div>
                    </div>

                    <div id="Overall_Progress_container">
                        <p style="font-size: 1.625rem; font-weight: bolder; margin-bottom: 0.625rem;">Completion Rate
                        </p>
                        <div id="Overall_Progress">
                            <div class="completion-text"><span id="completion-rate">20</span>% Completed</div>
                            <div id="container">
                                <div class="doughnut-chart"></div>
                            </div>
                            <div class="legend" style="display: flex; justify-content: center; margin-top: 0.625rem;">
                                <div style="display: flex; align-items: center; margin: 0 0.625rem;">
                                    <span class="legend-color completed"
                                        style="width: 0.9375rem; height: 0.9375rem; background-color: #00B158; display: inline-block; margin-right: 0.3125rem;"></span>
                                    Completed
                                </div>
                                <div style="display: flex; align-items: center; margin: 0 0.625rem;">
                                    <span class="legend-color remaining"
                                        style="width: 0.9375rem; height: 0.9375rem; background-color: #d1d5db; display: inline-block; margin-right: 0.3125rem;"></span>
                                    Remaining
                                </div>
                            </div>
                        </div>
                    </div>                </div>
            </div>
        </div>
    </div>
        </div> <!-- End Main content -->
    </div> <!-- End Container-body -->    <script th:inline="javascript">
        /*<![CDATA[*/
        // Get lecturer ID from server (passed from controller)
        const lecturerId = /*[[${lecturerId}]]*/ null;
        if (!lecturerId) {
            alert('User not authenticated. Please log in again.');
            window.location.href = '/login';
            throw new Error('No lecturer ID available');
        }
        console.log("Using lecturerId:", lecturerId);
          // Header and menu are loaded via Thymeleaf fragments, no need for fetch        // Load questions data from API
        function loadQuestions() {
            const selects = document.querySelectorAll('.filters select');
            const difficulty = selects[0] ? selects[0].value : '';
            const subject = selects[1] ? selects[1].value : '';
            const status = selects[2] ? selects[2].value : '';
              const params = new URLSearchParams();
            if (subject && subject !== '') params.append('subject', subject);
            if (status && status !== '') params.append('status', status);
            if (difficulty && difficulty !== '') params.append('difficulty', difficulty);
            params.append('lecturerId', lecturerId);
            // Add cache-busting parameter to ensure fresh data
            params.append('_t', Date.now());
            
            const url = `/lecturer/api/questions?${params.toString()}`;
            console.log("Fetching:", url);
            
            // Show loading state  
            const tbody = document.querySelector('.question-table tbody');
            tbody.innerHTML = '<tr><td colspan="6" class="loading">Loading questions...</td></tr>';
            
            fetch(url, {
                cache: 'no-cache',
                headers: {
                    'Cache-Control': 'no-cache',
                    'Pragma': 'no-cache'
                }
            })
                .then(response => {
                    console.log("Response status:", response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("API Response:", data);
                    if (data.error) {
                        showError('Server error: ' + data.error);
                        return;
                    }
                    updateQuestionsTable(data.questions || []);
                    updateProgressCharts(data.difficultyStats || {}, data.completionRate || 0);
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    showError('Failed to load questions: ' + error.message);
                });
        }

        // Show error message
        function showError(message) {
            const tbody = document.querySelector('.question-table tbody');
            tbody.innerHTML = `<tr><td colspan="6" class="error-message">${message}</td></tr>`;
        }        // Load subjects for filter dropdown
        function loadSubjects() {
            fetch('/lecturer/api/assigned-subjects')
                .then(response => response.json())
                .then(data => {
                    const selects = document.querySelectorAll('.filters select');
                    const subjectSelect = selects[1]; // Second dropdown is subject
                    if (subjectSelect) {
                        subjectSelect.innerHTML = '<option value="">All subject</option>';
                        
                        // Handle new API format - data is array of objects
                        if (Array.isArray(data)) {
                            data.forEach(subject => {
                                const option = document.createElement('option');
                                option.value = subject.subjectName; // Use subject name for filtering
                                option.textContent = subject.subjectName;
                                subjectSelect.appendChild(option);
                            });
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading subjects:', error);
                    // Fallback to old API if new one fails
                    fetch('/lecturer/api/subjects')
                        .then(response => response.json())
                        .then(subjects => {
                            const selects = document.querySelectorAll('.filters select');
                            const subjectSelect = selects[1];
                            if (subjectSelect) {
                                subjectSelect.innerHTML = '<option value="">All subject</option>';
                                subjects.forEach(subject => {
                                    const option = document.createElement('option');
                                    option.value = subject;
                                    option.textContent = subject;
                                    subjectSelect.appendChild(option);
                                });
                            }
                        })
                        .catch(fallbackError => {
                            console.error('Both APIs failed:', fallbackError);
                        });
                });
        }// Update questions table
        function updateQuestionsTable(questions) {
            const tbody = document.querySelector('.question-table tbody');
            
            if (!questions || questions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <i class="fas fa-question-circle"></i>
                            <p>No questions found. Create your first question to get started!</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = '';
              questions.forEach(question => {
                const row = document.createElement('tr');
                
                // Check if edit button should be shown based on status
                const canEdit = question.canEdit !== undefined ? question.canEdit : (question.status === 'draft' || question.status === 'rejected');
                const editButtonHtml = canEdit ? 
                    `<a href="/lecturer/edit-question?id=${question.id}"><button class="circle-button delete editQuestion"><i class="fa-solid fa-pen-to-square"></i></button></a>` : '';

                // Check if delete button should be shown (can only delete non-approved questions)
                const canDelete = question.canBeDeleted !== undefined ? question.canBeDeleted : (question.status !== 'approved');
                const deleteButtonHtml = canDelete ? 
                    `<button class="circle-button delete" onclick="deleteQuestion(${question.id})"><i class="fas fa-trash-alt"></i></button>` : '';

                row.innerHTML = `
                    <td>${question.subject || 'N/A'}</td>
                    <td title="${question.question}">${question.question.length > 100 ? question.question.substring(0, 100) + '...' : question.question}</td>
                    <td title="${question.correctAnswer}">${question.correctAnswer.length > 50 ? question.correctAnswer.substring(0, 50) + '...' : question.correctAnswer}</td>
                    <td>${question.otherAnswers || ''}</td>                    <td class="status-cell">
                        <div class="status-buttons">
                            <span class="difficulty-badge ${getDifficultyClass(question.difficulty)}">${getDifficultyDisplayText(question.difficulty)}</span>
                            <button class="status-action-button ${getStatusActionClass(question.status, question.canEdit)} ${question.canEdit && question.status === 'rejected' ? 'clickable' : 'non-clickable'}" ${question.canEdit && question.status === 'rejected' ? 'onclick="handleStatusAction(' + question.id + ', \'' + question.status + '\')"' : ''}>${getStatusActionText(question.status, question.canEdit)}</button>
                        </div>
                    </td>
                    <td>
                        <div class="action-buttons">
                            ${editButtonHtml}
                            ${deleteButtonHtml}
                        </div>
                    </td>
                `;                tbody.appendChild(row);
            });
        }

        // Update status of a question
        function updateQuestionStatus(questionId, action) {
            fetch(`/lecturer/api/questions/${questionId}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ action: action })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    loadQuestions(); // Reload to update the table
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to update question status');
            });
        }        // Delete a question
        function deleteQuestion(questionId) {
            if (confirm('Are you sure you want to delete this question?\n\nNote: If the question is used in exams or duplicate detection, it will be marked as deleted instead of permanently removed.')) {
                // Show loading state for the specific row
                const row = document.querySelector(`button[onclick="deleteQuestion(${questionId})"]`)?.closest('tr');
                if (row) {
                    row.style.opacity = '0.5';
                    row.style.pointerEvents = 'none';
                }
                
                fetch(`/lecturer/api/questions/${questionId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        // Restore row state
                        if (row) {
                            row.style.opacity = '1';
                            row.style.pointerEvents = 'auto';
                        }
                        
                        // Show more user-friendly error messages
                        if (data.error.includes('foreign key constraint') || data.error.includes('duplicate_detections')) {
                            alert('This question cannot be permanently deleted because it is referenced in other records (exams, duplicate detections, etc.). It has been marked as deleted instead.');
                        } else if (data.error.includes('approved') || data.error.includes('submitted')) {
                            alert('Cannot delete submitted or approved questions. Only draft questions can be deleted.');
                        } else if (data.error.includes('only delete your own')) {
                            alert('You can only delete questions that you created.');
                        } else {
                            alert('Error: ' + data.error);
                        }
                    } else {
                        alert('Question deleted successfully!');
                        // Force reload with a slight delay to ensure backend processing is complete
                        setTimeout(() => {
                            loadQuestions();
                        }, 500);
                    }
                })
                .catch(error => {
                    // Restore row state
                    if (row) {
                        row.style.opacity = '1';
                        row.style.pointerEvents = 'auto';
                    }
                    console.error('Error:', error);
                    alert('Failed to delete question. Please try again.');
                });
            }
        }// Helper function to get difficulty display text        // Helper function to get difficulty display text (old version - remove duplicates)
        function getDifficultyDisplayText(difficulty) {
            switch (difficulty.toLowerCase()) {
                case 'recognition': return 'Remember';
                case 'comprehension': return 'Understand';
                case 'basic_application': return 'Apply (Basic)';
                case 'advanced_application': return 'Apply (Advanced)';
                default: return difficulty;
            }
        }

        // Helper function to get difficulty CSS class
        function getDifficultyClass(difficulty) {
            switch (difficulty) {
                case 'recognition': return 'difficulty-recognition';
                case 'comprehension': return 'difficulty-comprehension';
                case 'basic_application': return 'difficulty-basic';
                case 'advanced_application': return 'difficulty-advanced';
                default: return 'difficulty-unknown';
            }
        }        // Helper function to get status action text
        function getStatusActionText(status, canEdit) {
            if (!canEdit) {
                switch (status) {
                    case 'submitted': return 'Submitted';
                    case 'approved': return 'Approved';
                    case 'declined': return 'Declined';
                    case 'archived': return 'Archived';
                    case 'rejected': return 'Rejected';
                    case 'draft': return 'Draft';
                    default: return 'Status';
                }
            }
            
            switch (status) {
                case 'draft': return 'Draft';
                case 'rejected': return 'Rejected';
                default: return 'Submit';
            }
        }        // Helper function to get status action CSS class
        function getStatusActionClass(status, canEdit) {
            if (!canEdit) {
                switch (status) {
                    case 'submitted': return 'status-submitted';
                    case 'approved': return 'status-approved';
                    case 'declined': return 'status-declined';
                    case 'archived': return 'status-archived';
                    case 'rejected': return 'status-rejected';
                    case 'draft': return 'status-draft';
                    default: return 'status-unknown';
                }
            }
            
            switch (status) {
                case 'draft': return 'status-draft';
                case 'rejected': return 'status-rejected';
                default: return 'status-editable';
            }
        }        // Submit a question for review
        function submitQuestion(questionId) {
            if (confirm('Are you sure you want to submit this question for review?')) {
                fetch(`/lecturer/api/questions/${questionId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action: 'submit' })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Error: ' + data.error);
                    } else {
                        alert('Question submitted for review successfully!');
                        loadQuestions(); // Reload to update the table
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to submit question');
                });
            }
        }

        // Helper function to get status display text from status value
        function getStatusDisplayFromStatus(status) {
            const statusMap = {
                'draft': 'Draft',
                'submitted': 'Submitted',
                'approved': 'Approved',
                'rejected': 'Rejected',
                'archived': 'Archived',
                'declined': 'Declined'
            };
            return statusMap[status.toLowerCase()] || capitalizeFirst(status);
        }

        // Helper function to get CSS class from status value
        function getStatusClassFromStatus(status) {
            return status.toLowerCase();
        }

        // Helper function to capitalize first letter
        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
        }        // Helper function to get difficulty display text
        function getDifficultyDisplayText(difficulty) {
            switch (difficulty.toLowerCase()) {
                case 'recognition': return 'Remember';
                case 'comprehension': return 'Understand';
                case 'basic_application': return 'Apply (Basic)';
                case 'advanced_application': return 'Apply (Advanced)';
                default: return difficulty;
            }
        }// Helper function to get difficulty CSS class
        function getDifficultyClass(difficulty) {
            switch (difficulty.toLowerCase()) {
                case 'recognition': return 'difficulty-recognition';
                case 'comprehension': return 'difficulty-comprehension';
                case 'basic_application': return 'difficulty-basic';
                case 'advanced_application': return 'difficulty-advanced';
                default: return 'difficulty-unknown';
            }        }

        // Helper function to get status action text
        function getStatusActionText(status, canEdit) {
            if (!canEdit) {
                switch (status.toLowerCase()) {
                    case 'submitted': return 'Submitted';
                    case 'approved': return 'Approved';
                    case 'declined': return 'Declined';
                    case 'archived': return 'Archived';
                    case 'rejected': return 'Rejected';
                    case 'draft': return 'Draft';
                    default: return 'Status';
                }
            }
            
            // Only rejected questions can be resubmitted
            switch (status.toLowerCase()) {
                case 'draft': return 'Draft';
                case 'rejected': return 'Rejected';
                default: return 'Submit';
            }
        }

        // Handle status action click
        function handleStatusAction(questionId, status) {
            // Only allow action for rejected questions (they can be resubmitted)
            if (status.toLowerCase() === 'rejected') {
                if (confirm('Are you sure you want to resubmit this question for review?')) {
                    submitQuestion(questionId);
                }
            }
        }// Update progress charts
        function updateProgressCharts(difficultyStats, completionRate) {
            // Update difficulty chart bars
            const barGroups = document.querySelectorAll('.bar-group');
            const total = Object.values(difficultyStats).reduce((sum, count) => sum + count, 0);
            
            if (total > 0 && barGroups.length >= 4) {
                const difficulties = ['recognition', 'comprehension', 'basic_application', 'advanced_application'];
                
                barGroups.forEach((barGroup, index) => {
                    const count = difficultyStats[difficulties[index]] || 0;
                    const percentage = Math.round((count / total) * 100);
                    
                    // Create or update bar
                    let bar = barGroup.querySelector('.bar');
                    if (!bar) {
                        bar = document.createElement('div');
                        bar.className = 'bar';
                        barGroup.appendChild(bar);
                    }
                    
                    // Set height based on percentage (max height 200px)
                    const maxHeight = 200;
                    const height = Math.max(5, (percentage / 100) * maxHeight);
                    bar.style.height = height + 'px';
                    
                    // Set color based on difficulty
                    const colors = ['#00BFFF', '#5EF05E', '#FF7D03', '#F25B5B'];
                    bar.style.backgroundColor = colors[index];
                    
                    // Add tooltip
                    bar.title = `${difficulties[index]}: ${count} questions (${percentage}%)`;
                });
            }
            
            // Update completion rate
            const completionRateElement = document.getElementById('completion-rate');
            if (completionRateElement) {
                completionRateElement.textContent = completionRate;
                updateDoughnutChart(completionRate);
            }
        }

        // Update doughnut chart
        function updateDoughnutChart(completionRate) {
            const chart = document.querySelector('.doughnut-chart');
            if (chart) {
                const percentage = Math.min(100, Math.max(0, completionRate));
                const completedDegrees = (percentage / 100) * 360;
                const remainingDegrees = 360 - completedDegrees;
                
                chart.style.background = `conic-gradient(
                    #00B158 0deg ${completedDegrees}deg,
                    #d1d5db ${completedDegrees}deg 360deg
                )`;
            }
        }

        // Tab switching functionality
        function initializeTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const currentAssignment = document.getElementById('Current_assignment');
            const progressTracking = document.getElementById('Progress_tracking');
            
            tabButtons.forEach((button, index) => {
                button.addEventListener('click', () => {
                    // Remove active class from all buttons
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    // Add active class to clicked button
                    button.classList.add('active');
                    
                    // Show/hide content based on tab
                    if (index === 0) {
                        currentAssignment.style.display = 'block';
                        progressTracking.style.display = 'none';
                    } else {
                        currentAssignment.style.display = 'none';
                        progressTracking.style.display = 'block';
                    }
                });
            });
        }        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializeTabs();
            loadSubjects();
            loadQuestions();
            
            // Add event listeners for filters
            document.querySelectorAll('.filters select').forEach(select => {
                select.addEventListener('change', loadQuestions);
            });
            
            // Initialize Progress Tracking to be hidden initially
            document.getElementById('Progress_tracking').style.display = 'none';
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Lấy các phần tử
            const currentAssignmentDiv = document.getElementById('Current_assignment');
            const progressTrackingDiv = document.getElementById('Progress_tracking');
            const tabButtons = document.querySelectorAll('.tab-button');

            // Mặc định hiển thị Current_assignment và ẩn Progress_tracking
            currentAssignmentDiv.style.display = 'block';
            progressTrackingDiv.style.display = 'none';

            // Thêm sự kiện click cho các nút tab
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Xóa lớp active khỏi tất cả các nút
                    tabButtons.forEach(btn => btn.classList.remove('active'));

                    // Thêm lớp active cho nút được nhấn
                    button.classList.add('active');

                    // Kiểm tra nội dung nút để hiển thị div tương ứng
                    if (button.textContent === 'Current Assignment') {
                        currentAssignmentDiv.style.display = 'block';
                        progressTrackingDiv.style.display = 'none';
                    } else if (button.textContent === 'Progress Tracking') {
                        currentAssignmentDiv.style.display = 'none';
                        progressTrackingDiv.style.display = 'block';
                    }
                });
            });
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Cập nhật chiều cao cột dựa trên giá trị trong .tooltip
            const bars = document.querySelectorAll('.bar');
            bars.forEach(bar => {
                const tooltip = bar.querySelector('.tooltip');
                if (tooltip) {
                    const percentage = parseInt(tooltip.textContent);
                    const height = percentage * 3;
                    bar.style.height = `${height}px`;
                }
            });

            // Cập nhật vòng tròn dựa trên giá trị trong #completion-rate
            const completionRate = document.getElementById('completion-rate');
            function updateDoughnut() {
                const rate = parseInt(completionRate.textContent);
                const doughnutChart = document.querySelector('.doughnut-chart');
                if (doughnutChart) {
                    doughnutChart.style.background = `conic-gradient(#00B158 0% ${rate}%, #d1d5db ${rate}% 100%)`;
                }
            }

            // Gọi hàm khi tải trang và khi giá trị thay đổi (nếu có sự kiện thay đổi)            updateDoughnut();

            // Thêm sự kiện nếu bạn muốn cập nhật khi thay đổi giá trị (ví dụ: nhập tay)
            completionRate.addEventListener('input', updateDoughnut); // Nếu là input, có thể cần điều chỉnh
        });
        /*]]>*/
    </script>
    <script src="../../Static/js/L_activeMenu.js"></script>
</body>

</html>
