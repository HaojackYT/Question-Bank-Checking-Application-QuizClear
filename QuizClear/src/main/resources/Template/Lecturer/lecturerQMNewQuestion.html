<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../Static/FontAwesome/css/all.css">
    <link rel="stylesheet" href="../../Static/header.css">
    <link rel="stylesheet" href="../../Static/web_styles.css">
    <link rel="stylesheet" href="../../Static/css/Lecturer/L_createQuestion.css">
    <link href="https://fonts.googleapis.com/css2?family=RocknRoll+One&display=swap" rel="stylesheet">
    <title>QuestionManager</title>
</head>

<body>
    <!--header-->
    <div id="header-placeholder"></div>

    <!-- body -->
    <div id="Container-body">
        <!-- Menu -->
        <div id="menu-HTML"></div>

        <!-- Main content -->
        <div id="main">
            <!-- noi dung duoc nhap trong day -->
            <div class="page-header">
                <button class="back-btn" onclick="history.back()">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="page-text">
                    <h1>New Question</h1>
                    <p>Don't forget to confirm your assigned task before starting a question!</p>
                </div>
            </div>

            <div id="main_container">
                <div class="info-section">
                    <h2 class="section-title">Information</h2>
                    <p class="section-subtitle">Enter detailed information for the new question</p>

                    <form>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Subject <span class="required">(*)</span></label>
                                <select class="form-input" id="subject" required>
                                    <option value="">Select subject...</option>
                                    <option value="Mathematics">Mathematics</option>
                                    <option value="Physics">Physics</option>
                                    <option value="Chemistry">Chemistry</option>
                                    <option value="Biology">Biology</option>
                                    <option value="Computer Science">Computer Science</option>
                                    <option value="English">English</option>
                                    <option value="History">History</option>
                                    <option value="Geography">Geography</option>
                                    <option value="Literature">Literature</option>
                                    <option value="Economics">Economics</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Difficulty Level <span class="required">(*)</span></label>
                                <select class="form-input" id="difficulty" required>
                                    <option value="">Select difficulty level...</option>
                                    <option value="remember">Remember</option>
                                    <option value="understand">Understand</option>
                                    <option value="apply">Apply(Basic)</option>
                                    <option value="analyze">Apply(Advance)</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group full-width">
                            <label class="form-label">Question Title</label>
                            <input type="text" class="form-input" placeholder="The title question...">
                        </div>

                        <!-- Duplicate Check -->
                        <div class="duplicate-check">
                            <div class="duplicate-header">
                                <i class="fa-solid fa-file-lines"></i>
                                <span class="duplicate-title">Duplicate Detection Check</span>
                            </div>
                            <p class="duplicate-subtitle">Check for similar questions before proceeding with submission
                            </p>
                            <div class="duplicate-status">
                                <span class="status-text">Ready to check</span>
                                <button type="button" class="check-button">Check Duplicates</button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Correct Answer <span class="required">(*)</span></label>
                            <input type="text" class="form-input" placeholder="Enter the correct answer...">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Incorrect Answers <span class="required">(*)</span></label>
                            <div class="incorrect-answers">
                                <input type="text" class="form-input" placeholder="Enter an incorrect answer...">
                                <input type="text" class="form-input" placeholder="Enter an incorrect answer...">
                                <input type="text" class="form-input" placeholder="Enter an incorrect answer...">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Correct answer explanation</label>
                            <textarea class="form-input" rows="4" placeholder="Enter explanation here..."></textarea>
                        </div>
                    </form>
                </div>                <!-- Footer -->
                <p class="footer-message" id="footer-message">Check for similar questions before proceeding with submission</p>
                <div class="footer-button">
                    <button class="save-draft" id="save-draft-btn">
                        Save Draft <i class="fa-regular fa-floppy-disk"></i>
                    </button>
                    <button class="submit-button">
                        Submit <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>


            <!-- ma nhung header vs menu -->            <script>
                // Load header
                fetch('/Static/Template/header_user.html')
                    .then(response => response.text())
                    .then(data => {
                        document.getElementById('header-placeholder').innerHTML = data;
                    })
                    .catch(error => console.log('Header load failed, using fallback'));

                // Load menu
                fetch('/Static/Template/Lecturer/Menu-Lecturer.html')
                    .then(response => response.text())
                    .then(data => {
                        document.getElementById('menu-HTML').innerHTML = data;
                        setActiveMenu(document.title);
                    })
                    .catch(error => {
                        console.log('Menu load failed, using fallback');
                        // Fallback menu basic
                        document.getElementById('menu-HTML').innerHTML = `
                            <div style="padding: 1rem; background: #f8f9fa;">
                                <nav>
                                    <a href="/lecturer/question-management" style="padding: 0.5rem; margin: 0.2rem; display: inline-block; background: #007bff; color: white; text-decoration: none; border-radius: 0.25rem;">Question Management</a>
                                    <a href="/lecturer/create-question" style="padding: 0.5rem; margin: 0.2rem; display: inline-block; background: #28a745; color: white; text-decoration: none; border-radius: 0.25rem;">Create Question</a>
                                </nav>
                            </div>
                        `;
                    });
            </script>            <script>
                document.addEventListener('DOMContentLoaded', () => {
                    const checkButton = document.querySelector('.check-button');
                    const statusText = document.querySelector('.status-text');
                    const questionTitleInput = document.querySelector('input[placeholder="The title question..."]');
                    const footerMessage = document.getElementById('footer-message');
                    const saveDraftBtn = document.getElementById('save-draft-btn');

                    if (checkButton && statusText && questionTitleInput) {
                        checkButton.addEventListener('click', async () => {
                            const title = questionTitleInput.value.trim();

                            if (!title) {
                                alert('Please enter the question title first.');
                                return;
                            }

                            checkButton.textContent = 'Checking...';
                            checkButton.disabled = true;
                            statusText.textContent = 'Checking for duplicates...';
                            statusText.classList.remove('safety', 'warring', 'error');

                            try {
                                // G·ªçi API check duplicate
                                const response = await fetch('/lecturer/api/check-duplicate', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({ questionTitle: title })
                                });

                                if (!response.ok) {
                                    throw new Error('Failed to check duplicates');
                                }

                                const data = await response.json();
                                const duplicatePercent = data.duplicatePercent;

                                // Hi·ªÉn th·ªã k·∫øt qu·∫£
                                if (duplicatePercent === 0) {
                                    statusText.textContent = 'No duplicates found';
                                    statusText.classList.add('safety');
                                    
                                    // C·∫≠p nh·∫≠t footer message v√† style cho Save Draft
                                    footerMessage.textContent = 'Duplicate check completed successfully! You can now save or submit.';
                                    footerMessage.style.color = '#22c55e'; // M√†u xanh
                                    
                                    // Chuy·ªÉn Save Draft button sang m√†u xanh
                                    saveDraftBtn.style.backgroundColor = '#22c55e';
                                    saveDraftBtn.style.color = 'white';
                                    saveDraftBtn.style.border = '1px solid #16a34a';
                                    
                                } else if (duplicatePercent < 50) {
                                    statusText.textContent = `${duplicatePercent}% duplicated`;
                                    statusText.classList.add('warring');
                                    
                                    footerMessage.textContent = 'Similar questions found. Please review before proceeding.';
                                    footerMessage.style.color = '#f59e0b'; // M√†u v√†ng
                                    
                                } else {
                                    statusText.textContent = `${duplicatePercent}% duplicated`;
                                    statusText.classList.add('error');
                                    
                                    footerMessage.textContent = 'High similarity detected! Please revise your question.';
                                    footerMessage.style.color = '#ef4444'; // M√†u ƒë·ªè
                                }

                                // Hi·ªÉn th·ªã similar questions n·∫øu c√≥
                                if (data.similarQuestions && data.similarQuestions.length > 0) {
                                    console.log('Similar questions found:', data.similarQuestions);
                                }

                            } catch (error) {
                                console.error('Duplicate check error:', error);
                                statusText.textContent = 'Error checking duplicates.';
                                statusText.classList.add('error');
                                
                                footerMessage.textContent = 'Error checking duplicates. Please try again.';
                                footerMessage.style.color = '#ef4444';
                            } finally {
                                checkButton.textContent = 'Check Duplicates';
                                checkButton.disabled = false;
                            }
                        });
                    }
                });                document.querySelector('.submit-button').addEventListener('click', async function (e) {
                    e.preventDefault();

                    // Basic validation - c·∫≠p nh·∫≠t ƒë·ªÉ ki·ªÉm tra c·∫£ select
                    const requiredInputs = document.querySelectorAll('input.form-input[placeholder*="Enter"]');
                    const requiredSelects = document.querySelectorAll('select.form-input[required]');
                    const incorrectAnswers = document.querySelectorAll('.incorrect-answers input');
                    const questionTitle = document.querySelector('input[placeholder="The title question..."]');

                    let isValid = true;

                    // Ki·ªÉm tra question title
                    if (!questionTitle.value.trim()) {
                        questionTitle.style.borderColor = '#ef4444';
                        isValid = false;
                    } else {
                        questionTitle.style.borderColor = '#d1d5db';
                    }

                    // Ki·ªÉm tra select fields
                    requiredSelects.forEach(select => {
                        if (!select.value.trim()) {
                            select.style.borderColor = '#ef4444';
                            isValid = false;
                        } else {
                            select.style.borderColor = '#d1d5db';
                        }
                    });

                    // Ki·ªÉm tra required input fields
                    requiredInputs.forEach(field => {
                        if (!field.value.trim()) {
                            field.style.borderColor = '#ef4444';
                            isValid = false;
                        } else {
                            field.style.borderColor = '#d1d5db';
                        }
                    });

                    // Ki·ªÉm tra incorrect answers
                    incorrectAnswers.forEach(field => {
                        if (!field.value.trim()) {
                            field.style.borderColor = '#ef4444';
                            isValid = false;
                        } else {
                            field.style.borderColor = '#d1d5db';
                        }
                    });

                    if (!isValid) {
                        alert('Please fill in all required fields.');
                        return;
                    }

                    try {
                        // Show loading state
                        const button = this;
                        const originalText = button.innerHTML;
                        button.innerHTML = 'Submitting... <i class="fa-solid fa-spinner fa-spin"></i>';
                        button.disabled = true;

                        // Collect form data
                        const formData = {
                            content: questionTitle.value.trim(),
                            correctAnswer: document.querySelector('input[placeholder="Enter the correct answer..."]').value.trim(),
                            answer1: incorrectAnswers[0].value.trim(),
                            answer2: incorrectAnswers[1].value.trim(),
                            answer3: incorrectAnswers[2].value.trim(),
                            explanation: document.querySelector('textarea').value.trim(),
                            action: 'submit'
                        };

                        console.log('Submitting question with data:', formData);

                        // Call API to submit question
                        const response = await fetch('/lecturer/api/questions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(formData)
                        });

                        if (!response.ok) {
                            throw new Error('Failed to submit question');
                        }

                        const data = await response.json();
                        
                        if (data.error) {
                            throw new Error(data.error);
                        }

                        // Success - show message and redirect
                        alert('Question submitted successfully!');
                        
                        // Redirect to Question Management page
                        window.location.href = '/lecturer/question-management';

                    } catch (error) {
                        console.error('Submit question error:', error);
                        alert('Error submitting question: ' + error.message);
                        
                        // Reset button state
                        const button = this;
                        button.innerHTML = 'Submit <i class="fas fa-paper-plane"></i>';
                        button.disabled = false;
                    }
                });// Save draft functionality
                document.querySelector('.save-draft').addEventListener('click', async function (e) {
                    e.preventDefault();

                    try {
                        // Show loading state
                        const button = this;
                        const originalText = button.innerHTML;
                        button.innerHTML = 'Saving... <i class="fa-solid fa-spinner fa-spin"></i>';
                        button.disabled = true;

                        // Collect form data
                        const formData = {
                            content: document.querySelector('input[placeholder="The title question..."]').value.trim(),
                            correctAnswer: document.querySelector('input[placeholder="Enter the correct answer..."]').value.trim(),
                            answer1: document.querySelectorAll('.incorrect-answers input')[0].value.trim(),
                            answer2: document.querySelectorAll('.incorrect-answers input')[1].value.trim(),
                            answer3: document.querySelectorAll('.incorrect-answers input')[2].value.trim(),
                            explanation: document.querySelector('textarea').value.trim(),
                            action: 'draft'
                        };

                        console.log('Saving draft with data:', formData);

                        // Call API to save draft
                        const response = await fetch('/lecturer/api/questions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(formData)
                        });

                        if (!response.ok) {
                            throw new Error('Failed to save draft');
                        }

                        const data = await response.json();
                        
                        if (data.error) {
                            throw new Error(data.error);
                        }

                        // Success - show message and redirect
                        alert('Draft saved successfully!');
                        
                        // Redirect to Question Management page
                        window.location.href = '/lecturer/question-management';

                    } catch (error) {
                        console.error('Save draft error:', error);
                        alert('Error saving draft: ' + error.message);
                        
                        // Reset button state
                        const button = this;
                        button.innerHTML = 'Save Draft <i class="fa-regular fa-floppy-disk"></i>';
                        button.disabled = false;
                    }
                });
            </script>

            <script src="../../Static/js/L_activeMenu.js"></script>
</body>

</html>