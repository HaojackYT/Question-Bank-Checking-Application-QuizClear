<!DOCTYPE html>
<html lang="en">

<head>    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" th:href="@{/Static/fontawesome/css/all.css}">
    <link rel="stylesheet" th:href="@{/Static/header.css}">
    <link rel="stylesheet" th:href="@{/Static/web_styles.css}">
    <link rel="stylesheet" th:href="@{/Static/css/Lecturer/L_createQuestion.css}">
    <link href="https://fonts.googleapis.com/css2?family=RocknRoll+One&display=swap" rel="stylesheet">
    <title>QuestionManager</title>
</head>

<body>    <!--header-->
    <div th:replace="~{header_user}"></div>

    <!-- body -->
    <div id="Container-body">
        <!-- Menu -->
        <div th:replace="~{Lecturer/Menu-Lecturer}"></div>

        <!-- Main content -->
        <div id="main">
            <!-- noi dung duoc nhap trong day -->
            <div class="page-header">
                <button class="back-btn" onclick="history.back()">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="page-text">
                    <h1>New Question</h1>
                    <p>Don't forget to confirm your assigned task before starting a question!</p>
                </div>
            </div>

            <div id="main_container">
                <div class="info-section">
                    <h2 class="section-title">Information</h2>
                    <p class="section-subtitle">Enter detailed information for the new question</p>

                    <form>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Subject <span class="required">(*)</span></label>
                                <select class="form-input" id="subject" required>
                                    <option value="">Select subject...</option>
                                    <option value="Mathematics">Mathematics</option>
                                    <option value="Physics">Physics</option>
                                    <option value="Chemistry">Chemistry</option>
                                    <option value="Biology">Biology</option>
                                    <option value="Computer Science">Computer Science</option>
                                    <option value="English">English</option>
                                    <option value="History">History</option>
                                    <option value="Geography">Geography</option>
                                    <option value="Literature">Literature</option>
                                    <option value="Economics">Economics</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Difficulty Level <span class="required">(*)</span></label>
                                <select class="form-input" id="difficulty" required>
                                    <option value="">Select difficulty level...</option>
                                    <option value="remember">Remember</option>
                                    <option value="understand">Understand</option>
                                    <option value="apply">Apply(Basic)</option>
                                    <option value="analyze">Apply(Advance)</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group full-width">
                            <label class="form-label">Question Title</label>
                            <input type="text" class="form-input" placeholder="The title question...">
                        </div>

                        <!-- Duplicate Check -->
                        <div class="duplicate-check">
                            <div class="duplicate-header">
                                <i class="fa-solid fa-file-lines"></i>
                                <span class="duplicate-title">Duplicate Detection Check</span>
                            </div>
                            <p class="duplicate-subtitle">Check for similar questions before proceeding with submission
                            </p>
                            <div class="duplicate-status">
                                <span class="status-text">Ready to check</span>
                                <button type="button" class="check-button">Check Duplicates</button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Correct Answer <span class="required">(*)</span></label>
                            <input type="text" class="form-input" placeholder="Enter the correct answer...">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Incorrect Answers <span class="required">(*)</span></label>
                            <div class="incorrect-answers">
                                <input type="text" class="form-input" placeholder="Enter an incorrect answer...">
                                <input type="text" class="form-input" placeholder="Enter an incorrect answer...">
                                <input type="text" class="form-input" placeholder="Enter an incorrect answer...">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Correct answer explanation</label>
                            <textarea class="form-input" rows="4" placeholder="Enter explanation here..."></textarea>
                        </div>
                    </form>
                </div>                <!-- Footer -->
                <p class="footer-message" id="footer-message" style="color: #ef4444; font-weight: 500;">Check for similar questions before proceeding with submission</p>
                <div class="footer-button">
                    <button class="save-draft" id="save-draft-btn">
                        Save Draft <i class="fa-regular fa-floppy-disk"></i>
                    </button>
                    <button class="submit-button" id="submit-btn">
                        Submit <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>            <script>
                document.addEventListener('DOMContentLoaded', () => {
                    const checkButton = document.querySelector('.check-button');
                    const statusText = document.querySelector('.status-text');
                    const questionTitleInput = document.querySelector('input[placeholder="The title question..."]');
                    const footerMessage = document.getElementById('footer-message');
                    const saveDraftBtn = document.getElementById('save-draft-btn');
                    const submitButton = document.querySelector('.submit-button');

                    // State variables
                    let aiCheckPassed = false;
                    let aiCheckResult = null;

                    // Debug logging
                    console.log('Elements found:');
                    console.log('checkButton:', checkButton);
                    console.log('statusText:', statusText);
                    console.log('questionTitleInput:', questionTitleInput);
                    console.log('footerMessage:', footerMessage);
                    console.log('saveDraftBtn:', saveDraftBtn);
                    console.log('submitButton:', submitButton);                    // Initialize button states
                    function initializeButtons() {
                        if (saveDraftBtn) {
                            saveDraftBtn.style.backgroundColor = '#22c55e';
                            saveDraftBtn.style.color = 'white';
                            saveDraftBtn.style.border = '1px solid #16a34a';
                            saveDraftBtn.disabled = false;
                        }
                        
                        if (submitButton) {
                            // Submit button - initially gray and disabled until AI check
                            submitButton.style.backgroundColor = '#9ca3af';
                            submitButton.style.color = '#6b7280';
                            submitButton.style.border = '1px solid #9ca3af';
                            submitButton.style.cursor = 'not-allowed';
                            submitButton.disabled = true;
                        }
                        
                        if (footerMessage) {
                            // Footer message - warning red initially
                            footerMessage.style.color = '#ef4444';
                            footerMessage.style.fontWeight = '500';
                            footerMessage.textContent = 'Check for similar questions before proceeding with submission';
                        }
                    }// Initialize buttons on page load
                    initializeButtons();

                    if (checkButton && statusText && questionTitleInput) {
                        checkButton.addEventListener('click', async () => {
                            const title = questionTitleInput.value.trim();
                            const subject = document.getElementById('subject').value.trim();
                            const difficulty = document.getElementById('difficulty').value.trim();
                            const correctAnswer = document.querySelector('input[placeholder="Enter the correct answer..."]').value.trim();
                            const incorrectAnswers = Array.from(document.querySelectorAll('.incorrect-answers input')).map(input => input.value.trim());

                            // Validate all required fields before AI check
                            if (!title) {
                                alert('Please enter the question title first.');
                                questionTitleInput.focus();
                                return;
                            }

                            if (!subject) {
                                alert('Please select a subject first.');
                                document.getElementById('subject').focus();
                                return;
                            }

                            if (!difficulty) {
                                alert('Please select difficulty level first.');
                                document.getElementById('difficulty').focus();
                                return;
                            }

                            if (!correctAnswer) {
                                alert('Please enter the correct answer first.');
                                document.querySelector('input[placeholder="Enter the correct answer..."]').focus();
                                return;
                            }

                            if (incorrectAnswers.some(ans => !ans)) {
                                alert('Please enter all incorrect answers first.');
                                document.querySelector('.incorrect-answers input:not([value])').focus();
                                return;
                            }

                            checkButton.textContent = 'Checking...';
                            checkButton.disabled = true;
                            statusText.textContent = 'Checking for duplicates...';
                            statusText.classList.remove('safety', 'warring', 'error');                            try {
                                // Gọi API check duplicate với đầy đủ thông tin câu hỏi
                                const questionData = {
                                    questionTitle: title,
                                    correctAnswer: correctAnswer,
                                    incorrectAnswers: incorrectAnswers,
                                    subject: subject,
                                    difficulty: difficulty
                                };

                                console.log('Sending duplicate check request:', questionData);

                                const response = await fetch('/lecturer/api/check-duplicate', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify(questionData)
                                });

                                console.log('Response status:', response.status);

                                if (!response.ok) {
                                    throw new Error(`HTTP ${response.status}: Failed to check duplicates`);
                                }                                const data = await response.json();
                                console.log('Duplicate check response:', data);
                                console.log('Type of duplicatePercent:', typeof data.duplicatePercent);
                                console.log('Value of duplicatePercent:', data.duplicatePercent);
                                console.log('duplicatePercent === 0:', data.duplicatePercent === 0);
                                console.log('duplicatePercent == 0:', data.duplicatePercent == 0);
                                  const duplicatePercent = data.duplicatePercent;
                                
                                // Null safety check
                                if (duplicatePercent === undefined || duplicatePercent === null) {
                                    console.error('duplicatePercent is undefined or null');
                                    statusText.textContent = 'Error: Invalid response from server';
                                    statusText.classList.add('error');
                                    return;
                                }                                // Hiển thị kết quả
                                if (duplicatePercent === 0) {
                                    statusText.textContent = 'No duplicates found';
                                    statusText.classList.add('safety');
                                    aiCheckPassed = true;
                                    
                                    footerMessage.textContent = 'Duplicate check completed successfully! You can now submit.';
                                    footerMessage.style.color = '#22c55e';
                                    footerMessage.style.fontWeight = '500';
                                    
                                    // Submit button turns green and enabled
                                    submitButton.style.backgroundColor = '#22c55e';
                                    submitButton.style.color = 'white';
                                    submitButton.style.border = '1px solid #16a34a';
                                    submitButton.style.cursor = 'pointer';
                                    submitButton.disabled = false;
                                    
                                } else if (duplicatePercent < 50) {
                                    statusText.textContent = `${duplicatePercent}% duplicated`;
                                    statusText.classList.add('warring');
                                    aiCheckPassed = false;
                                    
                                    footerMessage.textContent = 'Similar questions found. Submit button will ask for confirmation.';
                                    footerMessage.style.color = '#f59e0b';
                                    footerMessage.style.fontWeight = '500';
                                    
                                    // Submit button turns orange but enabled
                                    submitButton.style.backgroundColor = '#f59e0b';
                                    submitButton.style.color = 'white';
                                    submitButton.style.border = '1px solid #d97706';
                                    submitButton.style.cursor = 'pointer';
                                    submitButton.disabled = false;
                                    
                                } else {
                                    statusText.textContent = `${duplicatePercent}% duplicated`;
                                    statusText.classList.add('error');
                                    aiCheckPassed = false;
                                    
                                    footerMessage.textContent = 'High similarity detected! Submit button will ask for confirmation.';
                                    footerMessage.style.color = '#ef4444';
                                    footerMessage.style.fontWeight = '500';
                                    
                                    // Submit button turns red but enabled
                                    submitButton.style.backgroundColor = '#ef4444';
                                    submitButton.style.color = 'white';
                                    submitButton.style.border = '1px solid #dc2626';
                                    submitButton.style.cursor = 'pointer';
                                    submitButton.disabled = false;
                                }

                                aiCheckResult = duplicatePercent;                                // Hiển thị similar questions nếu có
                                if (data.similarQuestions && data.similarQuestions.length > 0) {
                                    console.log('Similar questions found:', data.similarQuestions);
                                }

                            } catch (error) {
                                console.error('Duplicate check error:', error);
                                statusText.textContent = 'Error checking duplicates.';
                                statusText.classList.add('error');
                                
                                footerMessage.textContent = 'Error checking duplicates. Please try again.';
                                footerMessage.style.color = '#ef4444';
                                aiCheckPassed = false;
                            } finally {
                                checkButton.textContent = 'Check Duplicates';
                                checkButton.disabled = false;
                            }
                        });
                    }                    // Submit button logic
                    if (submitButton) {
                        submitButton.addEventListener('click', async function (e) {
                            e.preventDefault();

                            // Check if submit button is disabled (AI check not run)
                            if (submitButton.disabled) {
                                alert('Please run the duplicate check first before submitting.');
                                return;
                            }

                            // If AI check failed (duplicates found), show confirmation
                            if (!aiCheckPassed && aiCheckResult !== null) {
                                const confirmMessage = `Warning: This question has ${aiCheckResult}% similarity with existing questions. Are you sure you want to submit anyway?`;
                                if (!confirm(confirmMessage)) {
                                    return;
                                }
                            }
                        
                        // Continue with submit validation and logic
                        const requiredInputs = document.querySelectorAll('input.form-input[placeholder*="Enter"]');
                        const requiredSelects = document.querySelectorAll('select.form-input[required]');
                        const incorrectAnswers = document.querySelectorAll('.incorrect-answers input');
                        const questionTitle = document.querySelector('input[placeholder="The title question..."]');

                        let isValid = true;

                        // Kiểm tra question title
                        if (!questionTitle.value.trim()) {
                            questionTitle.style.borderColor = '#ef4444';
                            isValid = false;
                        } else {
                            questionTitle.style.borderColor = '#d1d5db';
                        }

                        // Kiểm tra select fields
                        requiredSelects.forEach(select => {
                            if (!select.value.trim()) {
                                select.style.borderColor = '#ef4444';
                                isValid = false;
                            } else {
                                select.style.borderColor = '#d1d5db';
                            }
                        });

                        // Kiểm tra required input fields
                        requiredInputs.forEach(field => {
                            if (!field.value.trim()) {
                                field.style.borderColor = '#ef4444';
                                isValid = false;
                            } else {
                                field.style.borderColor = '#d1d5db';
                            }
                        });

                        // Kiểm tra incorrect answers
                        incorrectAnswers.forEach(field => {
                            if (!field.value.trim()) {
                                field.style.borderColor = '#ef4444';
                                isValid = false;
                            } else {
                                field.style.borderColor = '#d1d5db';
                            }
                        });

                        if (!isValid) {
                            alert('Please fill in all required fields.');
                            return;
                        }

                        try {
                            // Show loading state
                            const button = this;
                            const originalText = button.innerHTML;
                            button.innerHTML = 'Submitting... <i class="fa-solid fa-spinner fa-spin"></i>';
                            button.disabled = true;

                            // Collect form data
                            const formData = {
                                content: questionTitle.value.trim(),
                                correctAnswer: document.querySelector('input[placeholder="Enter the correct answer..."]').value.trim(),
                                answer1: incorrectAnswers[0].value.trim(),
                                answer2: incorrectAnswers[1].value.trim(),
                                answer3: incorrectAnswers[2].value.trim(),
                                explanation: document.querySelector('textarea').value.trim(),
                                action: 'submit'
                            };

                            console.log('Submitting question with data:', formData);

                            // Call API to submit question
                            const response = await fetch('/lecturer/api/questions', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(formData)
                            });

                            if (!response.ok) {
                                throw new Error('Failed to submit question');
                            }

                            const data = await response.json();
                            
                            if (data.error) {
                                throw new Error(data.error);
                            }                            // Success - show message and redirect
                            alert('Question submitted successfully!');
                            
                            // Redirect to Question Management page
                            window.location.href = '/lecturer/question-management';
                            
                        } catch (error) {
                            console.error('Submit question error:', error);
                            alert('Error submitting question: ' + error.message);
                            
                            // Reset button state
                            const button = this;
                            button.innerHTML = 'Submit <i class="fas fa-paper-plane"></i>';
                            button.disabled = false;
                        }
                        });
                    }

                    // Save draft functionality
                    if (saveDraftBtn) {
                        saveDraftBtn.addEventListener('click', async function (e) {
                            e.preventDefault();

                            try {
                                // Show loading state
                                const button = this;
                                const originalText = button.innerHTML;
                                button.innerHTML = 'Saving... <i class="fa-solid fa-spinner fa-spin"></i>';
                                button.disabled = true;

                                // Collect form data (no validation required for draft)
                                const formData = {
                                    content: document.querySelector('input[placeholder="The title question..."]').value.trim(),
                                    correctAnswer: document.querySelector('input[placeholder="Enter the correct answer..."]').value.trim(),
                                    answer1: document.querySelectorAll('.incorrect-answers input')[0].value.trim(),
                                    answer2: document.querySelectorAll('.incorrect-answers input')[1].value.trim(),
                                    answer3: document.querySelectorAll('.incorrect-answers input')[2].value.trim(),
                                    explanation: document.querySelector('textarea').value.trim(),
                                    subject: document.getElementById('subject').value.trim(),
                                    difficulty: document.getElementById('difficulty').value.trim(),
                                    action: 'draft'
                                };

                                console.log('Saving draft with data:', formData);

                                // Call API to save draft
                                const response = await fetch('/lecturer/api/questions', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify(formData)
                                });

                                if (!response.ok) {
                                    throw new Error('Failed to save draft');
                                }

                                const data = await response.json();
                                
                                if (data.error) {
                                    throw new Error(data.error);
                                }

                                // Success - show message and redirect
                                alert('Draft saved successfully! You can continue editing it later.');
                                
                                // Redirect to Question Management page
                                window.location.href = '/lecturer/question-management';

                            } catch (error) {
                                console.error('Save draft error:', error);
                                alert('Error saving draft: ' + error.message);
                                  // Reset button state
                                const button = this;
                                button.innerHTML = 'Save Draft <i class="fa-regular fa-floppy-disk"></i>';
                                button.disabled = false;
                            }
                        });
                    }
            });
            </script>

            <script src="../../Static/js/L_activeMenu.js"></script>
        </div>
    </div>
</body>

</html>