<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" th:href="@{/Static/fontawesome/css/all.css}">
    <link rel="stylesheet" th:href="@{/Static/header.css}">
    <link rel="stylesheet" th:href="@{/Static/web_styles.css}">
    <link rel="stylesheet" th:href="@{/Static/css/HED/HED_AssignManagement.css}">
    <link href="https://fonts.googleapis.com/css2?family=RocknRoll+One&display=swap" rel="stylesheet">
    <title>Assignment_Management</title>
</head>

<body>
    <!-- Header -->
    <div id="header-placeholder"></div>

    <!-- Body -->
    <div id="Container-body">
        <!-- Menu -->
        <div id="menu-HTML"></div>

        <!-- Main content -->
        <div id="main">
            <div class="assignment-container">                <div class="assignment-header">
                    <h1>Assignment Management</h1>
                    <button class="new-assign-btn" onclick="openNewAssignModal()">
                        <i class="fas fa-plus"></i> New Assign
                    </button>
                </div>

                <!-- Global notification area -->
                <div id="global-notification" class="global-notification" style="display: none;">
                    <span id="notification-message"></span>
                    <button id="close-notification" class="close-notification">&times;</button>
                </div>

                <!-- Notifications -->
                <div class="notification-section">
                    <h2>New Notification</h2>
                    <p class="notification-subtitle">Assignments to be completed</p>
                    <div class="notification_items"></div>
                    <button class="see-more-btn see-more" style="display: none;">See More</button>
                    <button class="see-less-btn see-more" style="display: none;">See Less</button>
                </div>

                <!-- Search and Filter -->
                <div class="search-filter-bar">
                    <div class="search-box">
                        <input type="text" placeholder="Enter search content ..." class="search-input">
                        <button class="search-btn">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <div class="filter-controls">
                        <div class="filter-dropdown">
                            <select class="filter-select" id="status-filter">
                                <option value="">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="in_progress">In Progress</option>
                                <option value="completed">Completed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="filter-dropdown">
                            <select class="filter-select" id="course-filter">
                                <option value="">All Courses</option>
                            </select>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    </div>
                </div>

                <!-- Assignment Table -->
                <div class="table-container">
                    <table class="assignment-table">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Course</th>
                                <th>Questions Required</th>
                                <th>Assigned Lecturer</th>
                                <th>Completed</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>                <!-- Pagination -->
                <div class="pagination">
                    <span class="page-info">Total Pages: <span id="total-pages" th:text="${totalPages ?: 1}">1</span></span>
                    <div class="pagination-controls">
                        <button class="page-btn" id="prev-page" th:disabled="${(currentPage ?: 0) == 0}">Previous</button>
                        <div id="page-numbers"></div>
                        <button class="page-btn" id="next-page"
                            th:disabled="${(currentPage ?: 0) == (totalPages ?: 1) - 1}">Next</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Assignment Modal -->
    <div id="newAssignModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>New Assignment</h2>
                <span class="close" onclick="closeNewAssignModal()">×</span>
            </div>
            <p class="modal-subtitle">Create new assignment for the lecturer from accepted plans/tasks.</p>
            <form id="newAssignForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>Select Accepted Task/Plan</label>
                        <select id="accepted-task-select" name="acceptedTaskId" required>
                            <option value="">Select Accepted Task/Plan</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Lecturer</label>
                        <select id="lecturer-select" name="lecturerId" required>
                            <option value="">Select Lecturer</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Course</label>
                        <select id="course-select" name="courseId" required disabled>
                            <option value="">Select Course</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Total Questions</label>
                        <input type="number" id="totalQuestions" name="totalQuestions" placeholder="From plan" 
                               class="small-input" required min="1" readonly>
                    </div>
                </div>
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="title" name="title" placeholder="From plan" required readonly>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="description" name="description" placeholder="From plan" required readonly></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Recognition Questions</label>
                        <input type="number" id="recognitionQuestions" name="recognitionQuestions" readonly>
                    </div>
                    <div class="form-group">
                        <label>Comprehension Questions</label>
                        <input type="number" id="comprehensionQuestions" name="comprehensionQuestions" readonly>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Basic Application Questions</label>
                        <input type="number" id="basicApplicationQuestions" name="basicApplicationQuestions" readonly>
                    </div>
                    <div class="form-group">
                        <label>Advanced Application Questions</label>
                        <input type="number" id="advancedApplicationQuestions" name="advancedApplicationQuestions" readonly>
                    </div>
                </div>
                <div class="form-group">
                    <label>Due Date</label>
                    <input type="datetime-local" id="dueDate" name="dueDate" required>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="submit-btn">Submit</button>
                </div>
            </form>
            <div id="form-error" class="error-message" style="display: none;"></div>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="detailsModal" class="modal">
        <div class="modal-content details-modal">
            <div class="modal-header">
                <h2>Assignment Details</h2>
                <span class="close" onclick="closeDetailsModal()">×</span>
            </div>
            <p class="modal-subtitle">Due: <span class="due-date"></span></p>
            <div class="details-content">
                <div class="detail-section">
                    <h3>Lecturer</h3>
                    <div class="lecturer-info">
                        <span></span>
                        <button class="download-btn"><i class="fas fa-download"></i></button>
                    </div>
                </div>
                <div class="detail-section">
                    <h3>Title</h3>
                    <p></p>
                </div>
                <div class="details-grid">
                    <div class="detail-item">
                        <h3>Total Questions</h3>
                        <p></p>
                    </div>
                    <div class="detail-item">
                        <h3>Course</h3>
                        <p></p>
                    </div>
                    <div class="detail-item">
                        <h3>Deadline</h3>
                        <p></p>
                    </div>
                    <div class="detail-item">
                        <h3>Status</h3>
                        <span class="status"></span>
                    </div>
                </div>
                <div class="detail-section">
                    <h3>Description</h3>
                    <p></p>
                </div>
                <div class="detail-section">
                    <h3>Feedback</h3>
                    <div class="feedback-box">
                        <p></p>
                    </div>
                </div>
                <div id="expandedContent" class="expanded-content" style="display: none;">
                    <div class="detail-section">
                        <h3>Questions</h3>
                        <div id="questions-list"></div>
                    </div>
                </div>
                <div class="see-more-container">
                    <button class="see-more-btn" onclick="toggleExpand()">See more...</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="reject-btn-modal" onclick="updateAssignmentStatus('REJECTED')">
                    <i class="fas fa-times"></i> Reject
                </button>
                <button class="approve-btn-modal" onclick="updateAssignmentStatus('APPROVED')">
                    <i class="fas fa-check"></i> Approve
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script th:inline="javascript">
        const BASE_URL = 'http://localhost:8081'; // Ensure this matches your backend port

        // Utility functions
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
        }        function showError(message, isSuccess = false) {
            // Try to use global notification first (for general messages)
            const globalNotification = document.getElementById('global-notification');
            const messageElement = document.getElementById('notification-message');
            
            if (globalNotification && messageElement) {
                messageElement.textContent = message;
                globalNotification.className = `global-notification ${isSuccess ? 'success' : 'error'}`;
                globalNotification.style.display = 'flex';
                
                // Auto-hide after 5 seconds
                setTimeout(() => {
                    globalNotification.style.display = 'none';
                }, 5000);
                
                return;
            }
            
            // Fallback to form-error (for modal messages)
            const errorDiv = document.getElementById('form-error');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.color = isSuccess ? 'green' : 'red';
                errorDiv.style.display = 'block';
                setTimeout(() => errorDiv.style.display = 'none', 5000);
            } else {
                // Last resort: use alert
                alert(message);
            }
        }async function fetchWithErrorHandling(url, options = {}) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    // Read the response body once as text
                    const responseText = await response.text();
                    let errorMessage;
                    
                    try {
                        // Try to parse as JSON to get structured error
                        const errorData = JSON.parse(responseText);
                        errorMessage = errorData.error || errorData.message || `HTTP ${response.status}`;
                    } catch (jsonError) {
                        // If not JSON, use the text as is
                        errorMessage = `Error ${response.status}: ${responseText || 'No error details provided'}`;
                    }
                    
                    throw new Error(errorMessage);
                }
                const text = await response.text();
                return text ? JSON.parse(text) : {};
            } catch (error) {
                console.error(`Fetch error for ${url}:`, error);
                throw error;
            }
        }

        // Modal controls
        function openNewAssignModal() {
            loadLecturers();
            loadCourses();
            document.getElementById('newAssignForm').reset();
            document.getElementById('newAssignModal').style.display = 'block';
        }

        function closeNewAssignModal() {
            document.getElementById('newAssignModal').style.display = 'none';
            document.getElementById('form-error').style.display = 'none';
        }        function openDetailsModal(taskId) {
            console.log('=== OPENING DETAILS MODAL DEBUG ===');
            console.log('Task ID:', taskId);
            
            fetchWithErrorHandling(`${BASE_URL}/hed/api/assignment?taskId=${taskId}`)
                .then(data => {
                    console.log('API Response for task', taskId, ':', data);
                    console.log('Response assignedLecturerName:', data.assignedLecturerName);
                    console.log('Response title:', data.title);
                    console.log('Response dueDate:', data.dueDate);
                    console.log('Response description:', data.description);
                    
                    const titleElement = document.querySelector('.details-modal h2');
                    if (titleElement) titleElement.textContent = `Details - ${data.title || 'N/A'} (ID: ${taskId})`;

                    const dueDateElement = document.querySelector('.due-date');
                    if (dueDateElement) dueDateElement.textContent = formatDate(data.dueDate);

                    const lecturerInfoElement = document.querySelector('.lecturer-info span');
                    if (lecturerInfoElement) {
                        console.log('Setting lecturer name to:', data.assignedLecturerName);
                        lecturerInfoElement.textContent = data.assignedLecturerName || 'N/A';
                    }

                    const detailSections = document.querySelectorAll('.detail-section');
                    if (detailSections.length >= 2) {
                        const titleParagraph = detailSections[1].querySelector('p');
                        if (titleParagraph) titleParagraph.textContent = data.title || 'N/A';
                    }

                    const detailItems = document.querySelectorAll('.detail-item');
                    if (detailItems.length >= 1) {
                        const totalQuestionsElement = detailItems[0].querySelector('p');
                        if (totalQuestionsElement) totalQuestionsElement.textContent = data.totalQuestions || '0';
                    }

                    if (detailItems.length >= 2) {
                        const courseElement = detailItems[1].querySelector('p');
                        if (courseElement) courseElement.textContent = data.courseName || 'N/A';
                    }

                    if (detailItems.length >= 3) {
                        const deadlineElement = detailItems[2].querySelector('p');
                        if (deadlineElement) deadlineElement.textContent = formatDate(data.dueDate);
                    }

                    if (detailItems.length >= 4) {
                        const statusElement = detailItems[3].querySelector('.status');
                        if (statusElement) {
                            statusElement.className = `status ${(data.status || '').toLowerCase()}`;
                            statusElement.textContent = (data.status || 'N/A').replace('_', ' ');
                        }
                    }

                    const descriptionElement = document.querySelector('.detail-section:nth-child(5) p');
                    if (descriptionElement) descriptionElement.textContent = data.description || 'No description';                    const feedbackElement = document.querySelector('.detail-section:nth-child(6) .feedback-box p');
                    if (feedbackElement) feedbackElement.textContent = data.feedback || 'No feedback';                    // Show/hide approve and reject buttons based on status
                    const modalFooter = document.querySelector('#detailsModal .modal-footer');
                    if (modalFooter) {
                        console.log('=== BUTTON VISIBILITY DEBUG ===');
                        console.log('Current assignment status:', data.status);
                        console.log('Status type:', typeof data.status);
                        console.log('Status comparison result:', data.status === 'completed');
                        console.log('Assignment ID:', data.taskId);
                        console.log('Assignment title:', data.title);
                        
                        if (data.status === 'completed') {
                            // Show approve/reject buttons only for completed assignments
                            modalFooter.style.display = 'block';
                            console.log('✓ SHOWING approve/reject buttons for completed assignment');
                        } else {
                            // Hide buttons for other statuses
                            modalFooter.style.display = 'none';
                            console.log('✗ HIDING approve/reject buttons for status:', data.status);
                        }
                        console.log('Modal footer display style:', modalFooter.style.display);
                        console.log('=== END BUTTON VISIBILITY DEBUG ===');
                    }

                    loadQuestions(taskId);
                    document.getElementById('detailsModal').style.display = 'block';
                    
                    console.log('=== END OPENING DETAILS MODAL DEBUG ===');
                })
                .catch(error => {
                    console.error('Error fetching assignment details:', error);
                    showError(`Failed to load assignment details: ${error.message}`);
                    console.log('=== END OPENING DETAILS MODAL DEBUG (ERROR) ===');
                });
        }

        function closeDetailsModal() {
            document.getElementById('detailsModal').style.display = 'none';
            document.getElementById('expandedContent').style.display = 'none';
            document.querySelector('.see-more-btn').textContent = 'See more...';
            document.querySelector('.details-modal').classList.remove('expanded');
        }

        function toggleExpand() {
            const expandedContent = document.getElementById('expandedContent');
            const seeMoreBtn = document.querySelector('.see-more-btn');
            const modal = document.querySelector('.details-modal');
            if (expandedContent.style.display === 'none') {
                expandedContent.style.display = 'block';
                seeMoreBtn.textContent = 'See less...';
                modal.classList.add('expanded');
            } else {
                expandedContent.style.display = 'none';
                seeMoreBtn.textContent = 'See more...';
                modal.classList.remove('expanded');
            }
        }

        window.onclick = function (event) {
            const newAssignModal = document.getElementById('newAssignModal');
            const detailsModal = document.getElementById('detailsModal');
            if (event.target === newAssignModal) closeNewAssignModal();
            if (event.target === detailsModal) closeDetailsModal();
        };        // Load dynamic data
        async function loadLecturers() {
            try {
                const lecturers = await fetchWithErrorHandling(`${BASE_URL}/hed/api/lecturers`);
                console.log('Lecturers loaded:', lecturers);
                const select = document.getElementById('lecturer-select');
                select.innerHTML = '<option value="">Select Lecturer</option>';
                lecturers.forEach(lecturer => {
                    const option = document.createElement('option');
                    option.value = lecturer.id;
                    option.textContent = lecturer.name || 'Unknown';
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error fetching lecturers:', error);
                showError(`Failed to load lecturers: ${error.message}`);
            }
        }async function loadCourses() {
    try {
        const courses = await fetchWithErrorHandling(`${BASE_URL}/hed/api/courses`);
        console.log('Courses loaded:', courses);
        if (!Array.isArray(courses) || courses.length === 0) {
            showError('No courses available');
            return;
        }
        const modalSelect = document.getElementById('course-select');
        const filterSelect = document.getElementById('course-filter');
        modalSelect.innerHTML = '<option value="">Select Course</option>';
        filterSelect.innerHTML = '<option value="">All Courses</option>';
        courses.forEach(course => {
            if (course.id && course.name) {
                const option = document.createElement('option');
                option.value = course.id;
                option.textContent = course.name;
                modalSelect.appendChild(option);
                filterSelect.appendChild(option.cloneNode(true));
            } else {
                console.warn('Invalid course data:', course);
            }
        });
    } catch (error) {
        console.error('Error fetching courses:', error);
        showError(`Failed to load courses: ${error.message}`);
    }
}        async function loadQuestions(taskId) {
            try {
                const questions = await fetchWithErrorHandling(`${BASE_URL}/hed/api/assignment/questions?taskId=${taskId}`);
                const questionsList = document.getElementById('questions-list');
                questionsList.innerHTML = '';
                if (!questions || questions.length === 0) {
                    questionsList.innerHTML = '<p>No questions available</p>';
                    return;
                }
                questions.forEach(question => {
                    const item = document.createElement('div');
                    item.className = 'question-item';
                    item.innerHTML = `
                        <div class="question-header">
                            <span class="question-title">${question.content || 'N/A'}</span>
                            <span class="difficulty-badge">${question.difficultyLevel || 'N/A'}</span>
                        </div>
                        <div class="question-options">
                            <div class="option ${question.answerKey === 'A' ? 'correct' : 'incorrect'}">
                                A. ${question.answerF1 || 'N/A'} ${question.answerKey === 'A' ? '<i class="fas fa-check"></i>' : '<i class="fas fa-times"></i>'}
                            </div>
                            <div class="option ${question.answerKey === 'B' ? 'correct' : 'incorrect'}">
                                B. ${question.answerF2 || 'N/A'} ${question.answerKey === 'B' ? '<i class="fas fa-check"></i>' : '<i class="fas fa-times"></i>'}
                            </div>
                            <div class="option ${question.answerKey === 'C' ? 'correct' : 'incorrect'}">
                                C. ${question.answerF3 || 'N/A'} ${question.answerKey === 'C' ? '<i class="fas fa-check"></i>' : '<i class="fas fa-times"></i>'}
                            </div>
                            <div class="option ${question.answerKey === 'D' ? 'correct' : 'incorrect'}">
                                D. ${question.explanation || 'N/A'} ${question.answerKey === 'D' ? '<i class="fas fa-check"></i>' : '<i class="fas fa-times"></i>'}
                            </div>
                        </div>
                        <div class="question-actions">
                            <button class="question-action-btn reject-btn" onclick="updateQuestionStatus(${question.questionId}, 'REJECTED')">
                                <i class="fas fa-times"></i>
                            </button>
                            <button class="question-action-btn approve-btn" onclick="updateQuestionStatus(${question.questionId}, 'APPROVED')">
                                <i class="fas fa-check"></i>
                            </button>
                        </div>
                    `;
                    questionsList.appendChild(item);
                });
            } catch (error) {
                console.error('Error fetching questions:', error);
                showError(`Failed to load questions: ${error.message}`);
            }
        }        function updateQuestionStatus(questionId, status) {
            if (!confirm(`Are you sure you want to ${status.toLowerCase()} this question?`)) return;
            fetchWithErrorHandling(`${BASE_URL}/api/hed/question/${questionId}/status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status })
            })
                .then(() => {
                    showError(`Question ${status.toLowerCase()} successfully`, true);
                    const taskId = document.querySelector('.details-modal h2').textContent.match(/ID: (\d+)/)[1];
                    loadQuestions(taskId);
                })
                .catch(error => {
                    console.error('Error updating question status:', error);
                    showError(`Failed to update question status: ${error.message}`);
                });
        }        function updateAssignmentStatus(status) {
            const action = status === 'APPROVED' ? 'approve' : 'reject';
            if (!confirm(`Are you sure you want to ${action} this assignment?`)) return;
            const taskIdMatch = document.querySelector('.details-modal h2').textContent.match(/ID: (\d+)/);
            if (!taskIdMatch) {
                showError('Unable to extract task ID');
                return;
            }
            const taskId = parseInt(taskIdMatch[1]);
            const buttons = document.querySelectorAll('.modal-footer button');
            buttons.forEach(btn => btn.disabled = true);

            // Use the dedicated approve/reject endpoints
            fetchWithErrorHandling(`${BASE_URL}/hed/api/tasks/${taskId}/${action}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ feedback: 'Processed by HED' })
            })
                .then(() => {
                    showError(`Assignment ${action}d successfully`, true);
                    closeDetailsModal();
                    loadAssignments(currentPage);
                })
                .catch(error => {
                    console.error('Error updating assignment status:', error);
                    showError(`Failed to ${action} assignment: ${error.message}`);
                })
                .finally(() => {
                    buttons.forEach(btn => btn.disabled = false);
                });
        }// Form submission
        document.getElementById('newAssignForm').addEventListener('submit', function (event) {
            event.preventDefault();
            const dueDate = document.getElementById('dueDate').value;
            if (!dueDate.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}/)) {
                showError('Due date must be in format YYYY-MM-DD HH:MM:SS');
                return;
            }
            
            const selectedLecturerId = document.getElementById('lecturer-select').value;
            const selectedCourseId = document.getElementById('course-select').value;
            
            // Debug: kiểm tra các giá trị được chọn
            console.log('=== FORM SUBMISSION DEBUG ===');
            console.log('Selected Lecturer ID:', selectedLecturerId);
            console.log('Selected Course ID:', selectedCourseId);
            console.log('Lecturer dropdown element:', document.getElementById('lecturer-select'));
            console.log('All lecturer options:', Array.from(document.getElementById('lecturer-select').options).map(opt => ({value: opt.value, text: opt.text})));
            
            // Kiểm tra xem có thực sự chọn lecturer không
            if (!selectedLecturerId || selectedLecturerId === '') {
                showError('Please select a lecturer');
                return;
            }
            
            if (!selectedCourseId || selectedCourseId === '') {
                showError('Please select a course');
                return;
            }
            
            const formData = {
                lecturerId: selectedLecturerId,
                courseId: selectedCourseId,
                totalQuestions: parseInt(document.getElementById('totalQuestions').value),
                title: document.getElementById('title').value,
                description: document.getElementById('description').value,
                dueDate: dueDate
            };
            
            console.log('Final assignment creation data:', formData);
            console.log('=== END FORM SUBMISSION DEBUG ===');fetchWithErrorHandling(`${BASE_URL}/hed/api/assignments`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            })
                .then(() => {
                    closeNewAssignModal();
                    loadAssignments(0);
                    showError('Assignment created successfully', true);
                })
                .catch(error => {
                    console.error('Error creating assignment:', error);
                    showError(`Failed to create assignment: ${error.message}`);
                });
        });        // Load header and menu
        fetch(/*[[@{/Template/header_user.html}]]*/)
            .then(res => res.text())
            .then(data => document.getElementById('header-placeholder').innerHTML = data)
            .catch(error => console.error('Error loading header:', error));
        fetch(/*[[@{/Template/HEAD_OF_DEPARTMENT/Menu-HED.html}]]*/)
            .then(response => response.text())
            .then(data => {
                document.getElementById('menu-HTML').innerHTML = data;
                setActiveMenu(document.title);
            })
            .catch(error => console.error('Error loading menu:', error));        // Pagination and table logic
        let currentPage = /*[[${currentPage ?: 0}]]*/ 0;
        const pageSize = 5;
          // Load assignments when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Assignment Management page loaded');
            loadAssignments(currentPage);
        });

        function loadAssignments(page = 0) {
    const searchValue = document.querySelector('.search-input').value;
    const statusValue = document.getElementById('status-filter').value;
    const courseValue = document.getElementById('course-filter').value;
    console.log('Loading assignments with:', { searchValue, statusValue, courseValue });    // Thay courseId thành subject để khớp với backend
    fetchWithErrorHandling(`${BASE_URL}/hed/api/assignments?search=${encodeURIComponent(searchValue)}&status=${statusValue}&subject=${courseValue}&page=${page}&size=${pageSize}&_=${new Date().getTime()}`)
        .then(data => {
            console.log('Assignments response:', data);
            updateTable(data.content || []);
            updatePagination(page, data.totalPages || 1);
            currentPage = page;
        })
        .catch(error => {
            console.error('Error fetching assignments:', error);
            updateTable([]);
            updatePagination(page, 1);
            showError(`Failed to load assignments: ${error.message}`);
        });
}        function updateTable(assignments) {
            console.log('=== UPDATE TABLE DEBUG ===');
            console.log('Assignments received:', assignments);
            
            const tbody = document.querySelector('.assignment-table tbody');
            tbody.innerHTML = '';
            if (!assignments || assignments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No assignments found</td></tr>';
                return;
            }
            assignments.forEach((assignment, index) => {
                console.log(`Assignment ${index + 1}:`, {
                    taskId: assignment.taskId,
                    title: assignment.title,
                    assignedLecturerName: assignment.assignedLecturerName,
                    courseName: assignment.courseName,
                    status: assignment.status
                });
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${assignment.title || 'N/A'}</td>
                    <td>${assignment.courseName || 'N/A'}</td>
                    <td>${assignment.totalQuestions || '0'}</td>
                    <td>${assignment.assignedLecturerName || 'N/A'}</td>
                    <td>${assignment.completedQuestions || '0'}</td>
                    <td><span class="status ${(assignment.status || '').toLowerCase()}">${(assignment.status || 'N/A').replace('_', ' ')}</span></td>
                    <td>
                        <button onclick="openDetailsModal(${assignment.taskId})"><i class="fas fa-eye"></i></button>
                        <button onclick="deleteAssignment(${assignment.taskId})"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                /*<button onclick="editAssignment(${assignment.taskId})"><i class="fas fa-edit"></i></button>*/
                tbody.appendChild(row);
            });
            console.log('=== END UPDATE TABLE DEBUG ===');
        }

        function updatePagination(currentPage, totalPages) {
            document.getElementById('total-pages').textContent = totalPages;
            const prevButton = document.getElementById('prev-page');
            const nextButton = document.getElementById('next-page');
            const pageNumbers = document.getElementById('page-numbers');
            prevButton.disabled = currentPage === 0;
            nextButton.disabled = currentPage >= totalPages - 1;
            pageNumbers.innerHTML = '';
            for (let i = 0; i < totalPages; i++) {
                const pageNumber = document.createElement('button');
                pageNumber.className = `page-number ${i === currentPage ? 'active' : ''}`;
                pageNumber.textContent = i + 1;
                pageNumber.onclick = () => loadAssignments(i);
                pageNumbers.appendChild(pageNumber);
            }
            prevButton.onclick = () => currentPage > 0 && loadAssignments(currentPage - 1);
            nextButton.onclick = () => currentPage < totalPages - 1 && loadAssignments(currentPage + 1);
        }        // Notification logic
        let allNotifications = [];
        const MAX_INITIAL_NOTIFICATIONS = 2;
        let isExpanded = false;

        function loadNotifications() {
            fetchWithErrorHandling(`${BASE_URL}/api/hed/notifications`)
                .then(data => {
                    allNotifications = data;
                    renderNotifications(isExpanded ? allNotifications.length : MAX_INITIAL_NOTIFICATIONS);
                    toggleButtons();
                })
                .catch(error => {
                    console.error('Error fetching notifications:', error);
                    showError(`Failed to load notifications: ${error.message}`);
                });
        }

        function renderNotifications(limit) {
            const notificationContainer = document.querySelector('.notification_items');
            notificationContainer.innerHTML = '';
            const notificationsToShow = allNotifications.slice(0, limit);
            notificationsToShow.forEach(notification => {
                const notificationItem = document.createElement('div');
                notificationItem.className = 'notification_item';
                notificationItem.innerHTML = `
                    <input type="checkbox">
                    <div class="notification-text">
                        <strong>${notification.title || 'N/A'}</strong>
                        <p>Course: ${notification.courseName || 'N/A'} | Due: ${formatDate(notification.dueDate)}</p>
                    </div>
                `;
                notificationContainer.appendChild(notificationItem);
            });
        }

        function toggleButtons() {
            const seeMoreButton = document.querySelector('.see-more-btn');
            const seeLessButton = document.querySelector('.see-less-btn');
            if (allNotifications.length > MAX_INITIAL_NOTIFICATIONS) {
                if (isExpanded) {
                    seeMoreButton.style.display = 'none';
                    seeLessButton.style.display = 'block';
                    seeLessButton.onclick = () => {
                        isExpanded = false;
                        renderNotifications(MAX_INITIAL_NOTIFICATIONS);
                        toggleButtons();
                    };
                } else {
                    seeMoreButton.style.display = 'block';
                    seeLessButton.style.display = 'none';
                    seeMoreButton.onclick = () => {
                        isExpanded = true;
                        renderNotifications(allNotifications.length);
                        toggleButtons();
                    };
                }
            } else {
                seeMoreButton.style.display = 'none';
                seeLessButton.style.display = 'none';
            }
        }

        // Placeholder for edit and delete
        function editAssignment(taskId) {
            showError('Edit functionality not implemented yet');
        }        function deleteAssignment(taskId) {
            if (confirm('Are you sure you want to delete this assignment?')) {
                console.log('=== DELETE ASSIGNMENT DEBUG ===');
                console.log('Deleting assignment with ID:', taskId);
                
                fetchWithErrorHandling(`${BASE_URL}/hed/api/assignments/${taskId}`, {
                    method: 'DELETE'
                })
                    .then(() => {
                        console.log('Assignment deleted successfully');
                        loadAssignments(currentPage);
                        showError('Assignment deleted successfully', true);
                        console.log('=== END DELETE ASSIGNMENT DEBUG ===');
                    })
                    .catch(error => {
                        console.error('Error deleting assignment:', error);
                        console.log('Delete error details:', error);
                        
                        // Show the specific error message from backend
                        let errorMessage = error.message || 'Failed to delete assignment';
                        
                        // Show error message to user
                        showError(errorMessage);
                        
                        console.log('=== END DELETE ASSIGNMENT DEBUG (ERROR) ===');
                    });
            }        }// Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Assignment Management page loaded');
            loadNotifications();
            loadAssignments(currentPage);
            loadCourses();
            document.querySelector('.search-btn').addEventListener('click', () => loadAssignments(0));
            
            // Add close notification event listener
            const closeNotificationBtn = document.getElementById('close-notification');
            if (closeNotificationBtn) {
                closeNotificationBtn.addEventListener('click', () => {
                    document.getElementById('global-notification').style.display = 'none';
                });
            }
            
            // Củng cố sự kiện change cho filter-select
            document.querySelectorAll('.filter-select').forEach(select => {
                select.addEventListener('change', () => {
                    console.log(`Filter changed: ${select.id} = ${select.value}`); // Debug: Log thay đổi bộ lọc
                    loadAssignments(0);
                });
            });
        });
    </script>
        <script>
            // Set active menu based on current page
            document.addEventListener('DOMContentLoaded', function () {
                setActiveMenu(document.title);
            });
        </script>
    <script th:src="@{/Static/js/L_activeMenu.js}"></script>
</body>

</html>