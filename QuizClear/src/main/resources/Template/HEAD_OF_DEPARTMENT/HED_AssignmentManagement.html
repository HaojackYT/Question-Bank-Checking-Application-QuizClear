<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/FontAwesome/css/all.css">
    <link rel="stylesheet" href="/header.css">
    <link rel="stylesheet" href="/web_styles.css">
    <link rel="stylesheet" href="/css/HED/HED_AssignManagement.css">
    <link href="https://fonts.googleapis.com/css2?family=RocknRoll+One&display=swap" rel="stylesheet">
    <title>Assignment Management</title>
</head>

<body>
    <!-- Header -->
    <div id="header-placeholder"></div>

    <!-- Body -->
    <div id="Container-body">
        <!-- Menu -->
        <div id="menu-HTML"></div>

        <!-- Main content -->
        <div id="main">
            <div class="assignment-container">
                <div class="assignment-header">
                    <h1>Assignment Management</h1>
                    <button class="new-assign-btn" onclick="openNewAssignModal()">
                        <i class="fas fa-plus"></i> New Assign
                    </button>
                </div>

                <!-- Notifications -->
                <div class="notification-section">
                    <h2>New Notification</h2>
                    <p class="notification-subtitle">Assignments to be completed</p>
                    <div class="notification_items"></div>
                    <button class="see-more-btn see-more" style="display: none;">See More</button>
                    <button class="see-less-btn see-more" style="display: none;">See Less</button>
                </div>

                <!-- Search and Filter -->
                <div class="search-filter-bar">
                    <div class="search-box">
                        <input type="text" placeholder="Enter search content ..." class="search-input">
                        <button class="search-btn">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <div class="filter-controls">
                        <div class="filter-dropdown">
                            <select class="filter-select" id="status-filter">
                                <option value="">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="in_progress">In Progress</option>
                                <option value="completed">Completed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="filter-dropdown">
                            <select class="filter-select" id="course-filter">
                                <option value="">All Courses</option>
                            </select>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    </div>
                </div>

                <!-- Assignment Table -->
                <div class="table-container">
                    <table class="assignment-table">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Course</th>
                                <th>Questions Required</th>
                                <th>Assigned Lecturer</th>
                                <th>Completed</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="pagination">
                    <span class="page-info">Total Pages: <span id="total-pages" th:text="${totalPages}">1</span></span>
                    <div class="pagination-controls">
                        <button class="page-btn" id="prev-page" th:disabled="${currentPage == 0}">Previous</button>
                        <div id="page-numbers"></div>
                        <button class="page-btn" id="next-page"
                            th:disabled="${currentPage == totalPages - 1}">Next</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Assignment Modal -->
    <div id="newAssignModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>New Assignment</h2>
                <span class="close" onclick="closeNewAssignModal()">×</span>
            </div>
            <p class="modal-subtitle">Create new assignment for the lecturer.</p>
            <form id="newAssignForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>Lecturer</label>
                        <select id="lecturer-select" name="lecturerId" required>
                            <option value="">Select Lecturer</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Course</label>
                        <select id="course-select" name="courseId" required>
                            <option value="">Select Course</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Total Questions</label>
                        <input type="number" id="totalQuestions" name="totalQuestions" placeholder="Enter number"
                            class="small-input" required min="1">
                    </div>
                </div>
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="title" name="title" placeholder="Enter title" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="description" name="description" placeholder="Enter description" required></textarea>
                </div>
                <div class="form-group">
                    <label>Due Date</label>
                    <input type="datetime-local" id="dueDate" name="dueDate" required>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="submit-btn">Submit</button>
                </div>
            </form>
            <div id="form-error" class="error-message" style="display: none;"></div>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="detailsModal" class="modal">
        <div class="modal-content details-modal">
            <div class="modal-header">
                <h2>Assignment Details</h2>
                <span class="close" onclick="closeDetailsModal()">×</span>
            </div>
            <p class="modal-subtitle">Due: <span class="due-date"></span></p>
            <div class="details-content">
                <div class="detail-section">
                    <h3>Lecturer</h3>
                    <div class="lecturer-info">
                        <span></span>
                        <button class="download-btn"><i class="fas fa-download"></i></button>
                    </div>
                </div>
                <div class="detail-section">
                    <h3>Title</h3>
                    <p></p>
                </div>
                <div class="details-grid">
                    <div class="detail-item">
                        <h3>Total Questions</h3>
                        <p></p>
                    </div>
                    <div class="detail-item">
                        <h3>Course</h3>
                        <p></p>
                    </div>
                    <div class="detail-item">
                        <h3>Deadline</h3>
                        <p></p>
                    </div>
                    <div class="detail-item">
                        <h3>Status</h3>
                        <span class="status"></span>
                    </div>
                </div>
                <div class="detail-section">
                    <h3>Description</h3>
                    <p></p>
                </div>
                <div class="detail-section">
                    <h3>Feedback</h3>
                    <div class="feedback-box">
                        <p></p>
                    </div>
                </div>
                <div id="expandedContent" class="expanded-content" style="display: none;">
                    <div class="detail-section">
                        <h3>Questions</h3>
                        <div id="questions-list"></div>
                    </div>
                </div>
                <div class="see-more-container">
                    <button class="see-more-btn" onclick="toggleExpand()">See more...</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="reject-btn-modal" onclick="updateAssignmentStatus('REJECTED')">
                    <i class="fas fa-times"></i> Reject
                </button>
                <button class="approve-btn-modal" onclick="updateAssignmentStatus('APPROVED')">
                    <i class="fas fa-check"></i> Approve
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Utility functions
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
        }

        function showError(message, isSuccess = false) {
            const errorDiv = document.getElementById('form-error');
            errorDiv.textContent = message;
            errorDiv.style.color = isSuccess ? 'green' : 'red';
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 5000);
        }

        // Modal controls
        function openNewAssignModal() {
            loadLecturers();
            loadCourses();
            document.getElementById('newAssignForm').reset();
            document.getElementById('newAssignModal').style.display = 'block';
        }

        function closeNewAssignModal() {
            document.getElementById('newAssignModal').style.display = 'none';
            document.getElementById('form-error').style.display = 'none';
        }

        function openDetailsModal(taskId) {
            fetch(`/hed/api/assignment?taskId=${taskId}`)
                .then(response => response.json())
                .then(data => {
                    const titleElement = document.querySelector('.details-modal h2');
                    if (titleElement) titleElement.textContent = `Details - ${data.title || 'N/A'} (ID: ${taskId})`;

                    const dueDateElement = document.querySelector('.due-date');
                    if (dueDateElement) dueDateElement.textContent = formatDate(data.dueDate);

                    const lecturerInfoElement = document.querySelector('.lecturer-info span');
                    if (lecturerInfoElement) lecturerInfoElement.textContent = data.assignedLecturerName || 'N/A';

                    const detailSections = document.querySelectorAll('.detail-section');
                    if (detailSections.length >= 2) {
                        const titleParagraph = detailSections[1].querySelector('p');
                        if (titleParagraph) titleParagraph.textContent = data.title || 'N/A';
                    }

                    const detailItems = document.querySelectorAll('.detail-item');
                    if (detailItems.length >= 1) {
                        const totalQuestionsElement = detailItems[0].querySelector('p');
                        if (totalQuestionsElement) totalQuestionsElement.textContent = data.totalQuestions || '0';
                    }

                    if (detailItems.length >= 2) {
                        const courseElement = detailItems[1].querySelector('p');
                        if (courseElement) courseElement.textContent = data.courseName || 'N/A';
                    }

                    if (detailItems.length >= 3) {
                        const deadlineElement = detailItems[2].querySelector('p');
                        if (deadlineElement) deadlineElement.textContent = formatDate(data.dueDate);
                    }

                    if (detailItems.length >= 4) {
                        const statusElement = detailItems[3].querySelector('.status');
                        if (statusElement) {
                            statusElement.className = `status ${(data.status || '').toLowerCase()}`;
                            statusElement.textContent = (data.status || 'N/A').replace('_', ' ');
                        }
                    }

                    const descriptionElement = document.querySelector('.detail-section:nth-child(5) p');
                    if (descriptionElement) descriptionElement.textContent = data.description || 'No description';

                    const feedbackElement = document.querySelector('.detail-section:nth-child(6) .feedback-box p');
                    if (feedbackElement) feedbackElement.textContent = data.feedback || 'No feedback';

                    loadQuestions(taskId);
                    document.getElementById('detailsModal').style.display = 'block';
                })
                .catch(error => {
                    console.error('Error fetching assignment details:', error);
                    showError('Failed to load assignment details');
                });
        }

        function closeDetailsModal() {
            document.getElementById('detailsModal').style.display = 'none';
            document.getElementById('expandedContent').style.display = 'none';
            document.querySelector('.see-more-btn').textContent = 'See more...';
            document.querySelector('.details-modal').classList.remove('expanded');
        }

        function toggleExpand() {
            const expandedContent = document.getElementById('expandedContent');
            const seeMoreBtn = document.querySelector('.see-more-btn');
            const modal = document.querySelector('.details-modal');
            if (expandedContent.style.display === 'none') {
                expandedContent.style.display = 'block';
                seeMoreBtn.textContent = 'See less...';
                modal.classList.add('expanded');
            } else {
                expandedContent.style.display = 'none';
                seeMoreBtn.textContent = 'See more...';
                modal.classList.remove('expanded');
            }
        }

        window.onclick = function (event) {
            const newAssignModal = document.getElementById('newAssignModal');
            const detailsModal = document.getElementById('detailsModal');
            if (event.target === newAssignModal) closeNewAssignModal();
            if (event.target === detailsModal) closeDetailsModal();
        };

        // Load dynamic data
        function loadLecturers() {
            fetch('/hed/api/lecturers')
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('lecturer-select');
                    select.innerHTML = '<option value="">Select Lecturer</option>';
                    data.forEach(lecturer => {
                        const option = document.createElement('option');
                        option.value = lecturer.id;
                        option.textContent = lecturer.name;
                        select.appendChild(option);
                    });
                })
                .catch(error => console.error('Error fetching lecturers:', error));
        }

        function loadCourses() {
            fetch('/hed/api/courses')
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('course-select');
                    const filterSelect = document.getElementById('course-filter');
                    select.innerHTML = '<option value="">Select Course</option>';
                    filterSelect.innerHTML = '<option value="">All Courses</option>';
                    data.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course.id;
                        option.textContent = course.name;
                        select.appendChild(option);
                        filterSelect.appendChild(option.cloneNode(true));
                    });
                })
                .catch(error => console.error('Error fetching courses:', error));
        }

        function loadQuestions(taskId) {
            fetch(`/hed/api/assignment/questions?taskId=${taskId}`)
                .then(response => response.json())
                .then(data => {
                    const questionsList = document.getElementById('questions-list');
                    questionsList.innerHTML = '';
                    if (data.length === 0) {
                        questionsList.innerHTML = '<p>No questions available</p>';
                        return;
                    }
                    data.forEach(question => {
                        const item = document.createElement('div');
                        item.className = 'question-item';
                        item.innerHTML = `
                            <div class="question-header">
                                <span class="question-title">${question.content || 'N/A'}</span>
                                <span class="difficulty-badge">${question.difficultyLevel || 'N/A'}</span>
                            </div>
                            <div class="question-options">
                                <div class="option ${question.answerKey === 'A' ? 'correct' : 'incorrect'}">
                                    A. ${question.answerF1 || 'N/A'} ${question.answerKey === 'A' ? '<i class="fas fa-check"></i>' : '<i class="fas fa-times"></i>'}
                                </div>
                                <div class="option ${question.answerKey === 'B' ? 'correct' : 'incorrect'}">
                                    B. ${question.answerF2 || 'N/A'} ${question.answerKey === 'B' ? '<i class="fas fa-check"></i>' : '<i class="fas fa-times"></i>'}
                                </div>
                                <div class="option ${question.answerKey === 'C' ? 'correct' : 'incorrect'}">
                                    C. ${question.answerF3 || 'N/A'} ${question.answerKey === 'C' ? '<i class="fas fa-check"></i>' : '<i class="fas fa-times"></i>'}
                                </div>
                                <div class="option ${question.answerKey === 'D' ? 'correct' : 'incorrect'}">
                                    D. ${question.explanation || 'N/A'} ${question.answerKey === 'D' ? '<i class="fas fa-check"></i>' : '<i class="fas fa-times"></i>'}
                                </div>
                            </div>
                            <div class="question-actions">
                                <button class="question-action-btn reject-btn" onclick="updateQuestionStatus(${question.questionId}, 'REJECTED')">
                                    <i class="fas fa-times"></i>
                                </button>
                                <button class="question-action-btn approve-btn" onclick="updateQuestionStatus(${question.questionId}, 'APPROVED')">
                                    <i class="fas fa-check"></i>
                                </button>
                            </div>
                        `;
                        questionsList.appendChild(item);
                    });
                })
                .catch(error => console.error('Error fetching questions:', error));
        }

        function updateQuestionStatus(questionId, status) {
            if (!confirm(`Are you sure you want to ${status.toLowerCase()} this question?`)) return;
            fetch(`/hed/api/question/${questionId}/status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status })
            })
                .then(response => {
                    if (!response.ok) return response.json().then(err => { throw new Error(err.error || 'Failed to update question status'); });
                    showError(`Question ${status.toLowerCase()} successfully`, true);
                    const taskId = document.querySelector('.details-modal h2').textContent.match(/ID: (\d+)/)[1];
                    loadQuestions(taskId);
                })
                .catch(error => {
                    console.error('Error updating question status:', error);
                    showError(error.message || 'Failed to update question status');
                });
        }

        function updateAssignmentStatus(status) {
            const action = status === 'APPROVED' ? 'approve' : 'reject';
            if (!confirm(`Are you sure you want to ${action} this assignment?`)) return;
            const taskIdMatch = document.querySelector('.details-modal h2').textContent.match(/ID: (\d+)/);
            if (!taskIdMatch) {
                showError('Unable to extract task ID');
                return;
            }
            const taskId = parseInt(taskIdMatch[1]);
            const mappedStatus = status === 'APPROVED' ? 'completed' : 'cancelled';
            const buttons = document.querySelectorAll('.modal-footer button');
            buttons.forEach(btn => btn.disabled = true); // Disable buttons during request

            fetch(`/hed/api/notifications/${taskId}/status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: mappedStatus })
            })
                .then(response => {
                    if (!response.ok) return response.json().then(err => { throw new Error(err.error || 'Failed to update assignment status'); });
                    showError(`Assignment ${action}d successfully`, true);
                    closeDetailsModal();
                    loadAssignments(currentPage);
                })
                .catch(error => {
                    console.error('Error updating assignment status:', error);
                    showError(error.message || 'Failed to update assignment status');
                })
                .finally(() => {
                    buttons.forEach(btn => btn.disabled = false); // Re-enable buttons
                });
        }

        // Form submission
        document.getElementById('newAssignForm').addEventListener('submit', function (event) {
            event.preventDefault();
            const formData = {
                lecturerId: document.getElementById('lecturer-select').value,
                courseId: document.getElementById('course-select').value,
                totalQuestions: document.getElementById('totalQuestions').value,
                title: document.getElementById('title').value,
                description: document.getElementById('description').value,
                dueDate: document.getElementById('dueDate').value
            };
            fetch('/hed/api/assignments', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            })
                .then(response => {
                    if (!response.ok) return response.json().then(err => { throw new Error(err.error || 'Failed to create assignment'); });
                    return response.json();
                })
                .then(() => {
                    closeNewAssignModal();
                    loadAssignments(0);
                    showError('Assignment created successfully', true);
                })
                .catch(error => {
                    console.error('Error creating assignment:', error);
                    showError(error.message || 'Failed to create assignment');
                });
        });

        // Load header and menu
        fetch('/template/header_user.html')
            .then(res => res.text())
            .then(data => document.getElementById('header-placeholder').innerHTML = data);
        fetch('/menu-hed')
            .then(response => response.text())
            .then(data => {
                document.getElementById('menu-HTML').innerHTML = data;
                setActiveMenu(document.title);
            });

        // Pagination and table logic
        let currentPage = /*[[${currentPage}]]*/ 0;
        const pageSize = 5;

        function loadAssignments(page = 0) {
            const searchValue = document.querySelector('.search-input').value;
            const statusValue = document.getElementById('status-filter').value;
            const courseValue = document.getElementById('course-filter').value;
            fetch(`/hed/api/assignments?search=${encodeURIComponent(searchValue)}&status=${statusValue}&subject=${courseValue}&page=${page}&size=${pageSize}&_=${new Date().getTime()}`)
                .then(response => {
                    if (!response.ok) throw new Error('Server error: ' + response.status);
                    return response.json();
                })
                .then(data => {
                    updateTable(data.content || []);
                    updatePagination(page, data.totalPages || 1);
                    currentPage = page;
                })
                .catch(error => {
                    console.error('Error fetching assignments:', error);
                    updateTable([]);
                    updatePagination(page, 1);
                    showError(error.message || 'Failed to load assignments');
                });
        }

        function updateTable(assignments) {
            const tbody = document.querySelector('.assignment-table tbody');
            tbody.innerHTML = '';
            if (!assignments || assignments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No assignments found</td></tr>';
                return;
            }
            assignments.forEach(assignment => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${assignment.title || 'N/A'}</td>
                    <td>${assignment.courseName || 'N/A'}</td>
                    <td>${assignment.totalQuestions || '0'}</td>
                    <td>${assignment.assignedLecturerName || 'N/A'}</td>
                    <td>${assignment.completedQuestions || '0'}</td>
                    <td><span class="status ${(assignment.status || '').toLowerCase()}">${(assignment.status || 'N/A').replace('_', ' ')}</span></td>
                    <td>
                        <button onclick="openDetailsModal(${assignment.taskId})"><i class="fas fa-eye"></i></button>
                        
                        <button onclick="deleteAssignment(${assignment.taskId})"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                /*<button onclick="editAssignment(${assignment.taskId})"><i class="fas fa-edit"></i></button>*/
                tbody.appendChild(row);
            });
        }

        function updatePagination(currentPage, totalPages) {
            document.getElementById('total-pages').textContent = totalPages;
            const prevButton = document.getElementById('prev-page');
            const nextButton = document.getElementById('next-page');
            const pageNumbers = document.getElementById('page-numbers');
            prevButton.disabled = currentPage === 0;
            nextButton.disabled = currentPage >= totalPages - 1;
            pageNumbers.innerHTML = '';
            for (let i = 0; i < totalPages; i++) {
                const pageNumber = document.createElement('button');
                pageNumber.className = `page-number ${i === currentPage ? 'active' : ''}`;
                pageNumber.textContent = i + 1;
                pageNumber.onclick = () => loadAssignments(i);
                pageNumbers.appendChild(pageNumber);
            }
            prevButton.onclick = () => currentPage > 0 && loadAssignments(currentPage - 1);
            nextButton.onclick = () => currentPage < totalPages - 1 && loadAssignments(currentPage + 1);
        }

        // Notification logic
        let allNotifications = [];
        const MAX_INITIAL_NOTIFICATIONS = 2;
        let isExpanded = false;

        function loadNotifications() {
            fetch('/hed/api/notifications')
                .then(response => response.json())
                .then(data => {
                    allNotifications = data;
                    renderNotifications(isExpanded ? allNotifications.length : MAX_INITIAL_NOTIFICATIONS);
                    toggleButtons();
                })
                .catch(error => console.error('Error fetching notifications:', error));
        }

        function renderNotifications(limit) {
            const notificationContainer = document.querySelector('.notification_items');
            notificationContainer.innerHTML = '';
            const notificationsToShow = allNotifications.slice(0, limit);
            notificationsToShow.forEach(notification => {
                const notificationItem = document.createElement('div');
                notificationItem.className = 'notification_item';
                notificationItem.innerHTML = `
                    <div class="notification-text">
                        <strong>${notification.title || 'N/A'}</strong>
                        <p>Course: ${notification.courseName || 'N/A'} | Due: ${formatDate(notification.dueDate)}</p>
                    </div>
                `;
                notificationContainer.appendChild(notificationItem);
            });
        }

        function toggleButtons() {
            const seeMoreButton = document.querySelector('.see-more-btn');
            const seeLessButton = document.querySelector('.see-less-btn');
            if (allNotifications.length > MAX_INITIAL_NOTIFICATIONS) {
                if (isExpanded) {
                    seeMoreButton.style.display = 'none';
                    seeLessButton.style.display = 'block';
                    seeLessButton.onclick = () => {
                        isExpanded = false;
                        renderNotifications(MAX_INITIAL_NOTIFICATIONS);
                        toggleButtons();
                    };
                } else {
                    seeMoreButton.style.display = 'block';
                    seeLessButton.style.display = 'none';
                    seeMoreButton.onclick = () => {
                        isExpanded = true;
                        renderNotifications(allNotifications.length);
                        toggleButtons();
                    };
                }
            } else {
                seeMoreButton.style.display = 'none';
                seeLessButton.style.display = 'none';
            }
        }

        // Placeholder for edit and delete
        function editAssignment(taskId) {
            showError('Edit functionality not implemented yet');
        }

        function deleteAssignment(taskId) {
            if (confirm('Are you sure you want to delete this assignment?')) {
                fetch(`/hed/api/assignments/${taskId}`, {
                    method: 'DELETE'
                })
                    .then(response => {
                        if (!response.ok) throw new Error('Failed to delete assignment');
                        loadAssignments(currentPage);
                        showError('Assignment deleted successfully', true);
                    })
                    .catch(error => {
                        console.error('Error deleting assignment:', error);
                        showError(error.message || 'Failed to delete assignment');
                    });
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadNotifications();
            loadAssignments(currentPage);
            document.querySelector('.search-btn').addEventListener('click', () => loadAssignments(0));
            document.querySelectorAll('.filter-select').forEach(select => {
                select.addEventListener('change', () => loadAssignments(0));
            });
        });
    </script>
    <script src="/js/L_activeMenu.js"></script>
</body>

</html>